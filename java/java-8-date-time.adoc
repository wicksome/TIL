= 날짜와 시간 API with Java8
Yeongjun.kim <opid911@gmail.com>
:revdate: 2018-02-21T17:50:00+09:00
:page-tags: java8, timezone, zoneId, date, time, datetime
:toc: left
:page-toc: left

WARNING: 기존 Java에서는 날짜와 시간을 `Date`, `Calendar` 그리고 `Timestamp` 클래스 등으로 다루고 있었다. 하지만 여러 문제점이 있으므로(https://d2.naver.com/helloworld/645609[Java의 날짜와 시간 API] 참고) 이 포스팅에서는 JDK8 이후에 추가된 API를 기반으로 설명한다.

[link=http://www.falkhausen.de/Java-8/java.time/Temporal-Hierarchy.html]
image:http://www.falkhausen.de/Java-8/java.time/Temporal-Hierarchy.png[]

글로벌 서비스를 하면서 JDK8이 제공하는 `java.time` 패키지가 너무 유용해서 정리해보고자 한다. 앞으로는 문자열을 파싱해서 사용하는 것보다 이 API을 사용해보자. (직접 구현한 코드들에는 시간 계산에 관한 버그가 너무나도 많았다..)

== 타임존

Time-Zone(타임존)은 여러 가지 다른 것을 설명하는 데 사용할 수 있지만 대개 지역 또는 국가의 현지 시간을 나타내며, 주로 해당 국가에 의해 법적으로 지정된다. 
*GMT* 와 *UTC* 는 같은 시간을 가르키면서 혼용되어 사용되지만, 엄밀히 구분하자면 다른 의미이다(https://ko.wikipedia.org/wiki/%ED%98%91%EC%A0%95_%EC%84%B8%EA%B3%84%EC%8B%9C[완전히 동일하진 않고 초의 소숫점 단위에서 차이가 난다]).

[NOTE]
====

[quote, 'https://www.timeanddate.com/time/gmt-utc-time.html[The Difference Between GMT and UTC]']
____
"GMT is a **time zone** and UTC is a **time standard**."
____

GMT(Greenwich Mean Time)::
GMT는 경도 0도에 위치한 영국 런던 그리니치에 있는 왕립 천문대의 시간으로, 모든 시간대의 시작점을 나타내며, 일년내내 DST의 영향을 받지 않는다.
GMT는 1925년 2월 5일부터 사용하기 시작했으며, 1972년 1월 1일까지 세계 표준시로 사용되었다.

UTC(협정 세계시, 協定世界時)::
UTC는 국제 표준시를 뜻하며 타임존은 아니다. 즉, 공식적으로 UTC를 현지 시간으로 사용하는 국가나 지역은 없다. 
협정 세계시를 영어권에서는 Coordinated Universal Time^CUT^라고, 프랑스어권에서는 Temps Universel Coordonné^TUC^라고 하는데, 혼돈을 방지하기 위해서 공식적으로 UTC라고 정해졌다.
====

위에 말한 듯이 타임존은 정부에 의해 변경되는 경우가 종종 있다. 하지만 Java는 타임존 변경이 일어났더라도 따로 JDK 버전업 필요 없이 독립적으로 타임존 데이터베이스(https://www.iana.org/time-zones:[IANA 데이터베이스])를 업데이트한다. 즉, 하드코딩으로 관리하지 않아도 된다. 

Java 8에서는 날짜와 시간을 좀 더 편리하게 하용하기 위해 여러 API가 추가되었으며, 타임존 또한 `ZoneId` 클래스를 통해 *DST* 가 적용된 시간도 편리하게 계산할 수 있다. `ZoneId.getAvailableZoneIds()` 를 통해 지원하는 지역별 타임존을 확인할 수 있다(현재 시점 등록된 ZoneId는 600개이다).

[NOTE]
.DST(Daylight Saving time)
====
DST은 자연 일광을 보다 잘 활용하기 위해서 여름철에 표준 시간에서 1시간 앞으로, 그리고 다시 가을에 시간을 1시간 전으로 설정하는
것을 말한다. DST와 "summer time"은 같은 말을 뜻하며 특정 나라에서 주로 불린다. 영국에서 썸머타임이라고 많이 사용하며, DST가 적용되지 않는 표준시는
"winter time"이라고 사용되기도 한다. DST를 독일에서는 "sommerzeit", 스칸디나비아에서는 "sommertid"라고도 사용한다.
====

.Java8에서 개선된 날짜, 시간 관련 API
|===
| Java8 이전 | Java8 이후

| `Timestamp`
| `Instant`

| `TimeZone`
| `ZoneId`

| `Date`     
| `LocalDate`     


| `Date`     
| `LocalDateTime`     

| `Calendar`
| `ZonedDateTime`     

| `TemporalAdjuster`  

| `SimpleDateFormat`
| `DateTimeFormatter` 
|===

== 레거시 전환하기

[#date-to-java8-datetime]
=== `Date`

[source, java]
.`Date` -> `LocalDate`
----
Date date = new Date();

LocalDate localDate1 = date.toInstant()
  .atZone(ZoneId.systemDefault())
  .toLocalDate();

LocalDate localDate2 = Instant.ofEpochMilli(date.getTime())
  .atZone(ZoneId.systemDefault())
  .toLocalDate();

LocalDate localDate3 = new java.sql.Date(date.getTime()).toLocalDate();
----

[source, java]
.`Date` -> `LocalDateTime`
----
Date date = new Date();

LocalDate localDateTime1 = date.toInstant()
  .atZone(ZoneId.systemDefault())
  .toLocalDate();

LocalDate localDateTime2 = Instant.ofEpochMilli(date.getTime())
  .atZone(ZoneId.systemDefault())
  .toLocalDateTime();

LocalDate localDateTime3 = new java.sql.Date(date.getTime()).toLocalDateTime();
----

[source, java]
.`Date` -> `Instant`
----
----

[source, java]
.`Date` -> `String`
----
----

[source, java]
.`Date` -> `ZonedDateTime`
----
----

=== `Calendar`

=== `Timestamp`

=== `SimpleDateFormat`


== 시간 변환하기




=== `Instant`

`Instant` 는 Immutable 하고 thread-safe하다.

=== `LocalDate`

=== `LocalDateTime`

=== `ZonedDateTime`

=== `TemporalAdjuster`



=== `TemporalAdjusters`

자주 사용될 것 같은 시간과 날짜를 조절하는 `TemporalAdjuster` 인터페이스를 구현해둔 유틸성 클래스이다.

위에 모든 클래스들이 `Temporal` 을 구현하고 있는데 이를 좀더 유틸로 만들어준거

[source, java]
----
LocalDate today = LocalDate.now();

today.with(TemporalAdjusters.firstDayOfYear());                      // 올해 1일
today.with(TemporalAdjusters.firstDayOfNextYear());                  // 내년 1일
today.with(TemporalAdjusters.firstDayOfMonth());                     // 이번달 1일
today.with(TemporalAdjusters.firstDayOfNextMonth());                 // 다음달 1일
today.with(TemporalAdjusters.firstInMonth(DayOfWeek.SUNDAY));        // 이번달 첫 번째 일요일
today.with(TemporalAdjusters.lastDayOfYear());                       // 올해 마지막날
today.with(TemporalAdjusters.lastDayOfMonth());                      // 이번달 마지막날
today.with(TemporalAdjusters.lastInMonth(DayOfWeek.SUNDAY));         // 이번달 마지막 일요일
today.with(TemporalAdjusters.next(DayOfWeek.MONDAY));                // 다음 월요일
today.with(TemporalAdjusters.nextOrSame(DayOfWeek.MONDAY));          // 다음 월요일(당일 포함)
today.with(TemporalAdjusters.previous(DayOfWeek.MONDAY));            // 지난 월요일
today.with(TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY));      // 지난 월요일(당일 포함)
today.with(TemporalAdjusters.dayOfWeekInMonth(2, DayOfWeek.SUNDAY)); // 이번달 2번째 일요일
today.with(TemporalAdjusters.ofDateAdjuster(date -> date.minusMonths(2))); // 커스터마이징
----

=== `DateTimeFomatter`

=== `Date` 에서 `LocalDate`, `LocalDateTime` 으로 전환하기



[#calendar-to-java8-datetime]
=== `Calendar` 에서 `LocalDate`, `LocalDateTime`, `ZonedDateTime` 으로 전환하기

[source, java]
----
final Calendar cal = Calendar.getInstance();
final TimeZone timeZone = Optional.ofNullable(cal.getTimeZone()).orElse(TimeZone.getDefault());

// LocalDate
LocalDate localDate = LocalDateTime.ofInstant(cal.toInstant(), timeZone.toZoneId()).toLocalDate();

// LocalDateTime
LocalDateTime localDateTime = LocalDateTime.ofInstant(cal.toInstant(), timeZone.toZoneId());

// ZonedDateTime
ZonedDateTime zonedDateTime = ZonedDateTime.ofInstant(cal.toInstant(), timeZone.toZoneId());
----

[#convert-string-to-java8-datetime]
=== `String` 에서 `LocalDate`, `LocalDateTime`, `ZonedDateTime` 으로 전환하기

[source, java]
----
LocalDateTime.parse(str);
LocalDateTime.parse(str, DateTimeFormatter.ofPattern("yyyyMMdd HH:mm:ss"));
----

[#convert-localdate]
=== `LocalDate` 에서 `LocalDateTime`, `ZonedDateTime` 으로 변환하기

[source, java]
----

----

[#convert-zoneddatetime]
=== `ZonedDateTime` 에서 `LocalDateTime`, `LocalDate` 으로 변환하기

[source, java]
----

----

== 실용 예제

[#get-yesterday-start]
=== 어제 00:00:00 구하기

[source, java]
----
LocalDateTime dateTime1 = LocalDate.now()
    .atTime(LocalTime.MIN)
    .minus(1, ChronoUnit.DAYS);

LocalDateTime dateTime2 = LocalDate.now()
    .atStartOfDay()
    .minus(1, ChronoUnit.DAYS);

LocalDateTime dateTime3 = LocalDateTime.now()
    .truncatedTo(ChronoUnit.DAYS)
    .minus(1, ChronoUnit.DAYS);
----

[source, java]
----
ZonedDateTime zonedDateTime = LocalDate.now()
    .minus(1, ChronoUnit.DAYS)
    .atStartOfDay(ZoneId.of("Asia/Seoul"));
----

[#get-yesterday-last]
=== 어제 23:59:59 구하기

[source, java]
----
final String actual = LocalDateTime.now()
    .minus(1, DAYS)
    .truncatedTo(DAYS)
    .format(DateTimeFormatter.ofPattern("yyyyMMddHHmmss"));
// 20191204235959
----

=== 타임존과 오프셋 커스텀하게 출력하기

[source]
----
GMT-04:00 Santiago
GMT+09:00 Seoul
GMT+10:00 Sydney
----

위와 같이 출력하고자 할 경우 아래와 같다.

[source, java]
----
// 현재 시간 기준(2018/03/21)
final List<ZoneId> timeZones = new ArrayList<>();
timeZones.add(ZoneId.of("America/Santiago"));
timeZones.add(ZoneId.of("Asia/Seoul"));
timeZones.add(ZoneId.of("Australia/Sydney"));

timeZones.forEach(zoneId -> {
    final ZoneOffset offset = zoneId.getRules().getStandardOffset(Instant.now());
    System.out.println(String.format("GMT%s %s", offset.getId(), zoneId.getId().split("/")[1]));
});
----

위 코드에는 한 가지 이슈가 있다. 현재 시점(2018년 2월 21일)에 Santiago는 DST가 시행중으로 offset은 1시간 당긴 `-03:00` 이다. 하지만, `getStandardOffset()` 은 표준 오프셋을 가져오므로 `-04:00` 를 출력한다(Sydney도 동일하다). 아래와 같이 `offset` 을 선언하면 DST가 적용된 offset을 가져올 수 있다.

[source, java]
----
final ZoneOffset offset = LocalDateTime.now().atZone(zoneId).getOffset();
----

[NOTE]
.생각해보기
====
이 https://www.timeanddate.com/time/gmt-utc-time.html[글]에서 GMT는 DST로 변하지 않는다고 말한다. 그러면 위 코드처럼 DST가 적용된 시간을 `GMT{offset}` 으로 출력해도 되는가? 여러가지 생각해봤지만 어느것이 맞는지 더 찾아봐야겠다.

* 각 나라의 표준시를 보여줄 것인가?
* DST를 적용한 GMT를 보여줄 것인가?
* DST를 적용한 UTC를 보여줄 것인가?
* 따로 DST 적용기간 아이콘을 보여줄 것인가?

구글 캘린더에서는 `(GMT-03:00) 산티아고` 라고 DST를 적용한 GMT시간을 보여준다.
====

=== LocalDateTime 에 ZoneId 설정하기

특정 지역 시간(localDateTime)에 Zone-ID를 추가하려면 아래와 같다.

[source]
----
localDateTime.atZone(ZoneId zoneId);
ZonedDateTime.of(LocalDateTime localDateTime, ZoneId zoneId);
----

[source, java]
.Example
----
final LocalDateTime localDateTime = LocalDateTime.of(2017, Month.OCTOBER, 18, 9, 0);
final ZonedDateTime zonedDateTime1 = localDateTime.atZone(ZoneId.of("UTC"));
final ZonedDateTime zonedDateTime2 = ZonedDateTime.of(localDateTime, ZoneId.of("Asia/Seoul"));
System.out.println(zonedDateTime1);
System.out.println(zonedDateTime2);
----

[source]
.Output
----
2017-10-18T09:00Z[UTC]
2017-10-18T09:00+09:00[Asia/Seoul]
----

**참고**

아래 코드와 같은 실수는 하지말자. `atZone()` 은 Zone 정보만 추가할뿐 시간을 변경하지 않는다. 그러므로 `localDateTime1` 과 `localDateTime2` 는 동일하다.

```java
final LocalDateTime localDateTime1 = localDateTime.atZone(seoul).toLocalDateTime();
final LocalDateTime localDateTime2 = localDateTime.atZone(utc).toLocalDateTime();
```

[#change-timezone]
=== 타임존 변경하기

==== 다른 타임존의 시간으로 변경하기(e.g. LA 시간 기준으로 서울시간 구하기)

예를 들어, 로스앤젤레스 시간으로 오전 9시가 서울 시간으로 몇시일지 확인하려고 하려고 한다. 아래와 같이 `withZoneSameInstant(ZoneId)` 를 사용하여 시간을 구할 수 있다.

[source, java]
----
// given
final LocalDateTime localDateTime = LocalDateTime.of(2017, Month.OCTOBER, 18, 9, 0);

// when
final ZonedDateTime losAngeles = localDateTime.atZone(ZoneId.of("America/Los_Angeles")); // <1>
final ZonedDateTime seoul = losAngeles.withZoneSameInstant(ZoneId.of("Asia/Seoul")); // <2>

// then
assertEquals(losAngeles.toInstant(), seoul.toInstant());
----
<1> 출력 결과: _2017-10-18T09:00-07:00[America/Los_Angeles]_
<2> 출력 결과: _2017-10-19T01:00+09:00[Asia/Seoul]_

==== 시간은 그대로 두고 타임존만 변경하기

시간대(`ZoneId`)만 변경하고자할 땐, `withZoneSameLocal(ZoneId)` 를 사용한다. 즉, 아래 코드에서 _Los_Angeles_ 와 _seoul_ 의 `localDateTime` 은 같다.

[source,java]
----
// given
final LocalDateTime localDateTime = LocalDateTime.of(2017, Month.OCTOBER, 18, 9, 0);

// when
final ZonedDateTime losAngeles = localDateTime.atZone(ZoneId.of("America/Los_Angeles")); // <1>
final ZonedDateTime seoul = losAngeles.withZoneSameLocal(ZoneId.of("Asia/Seoul")); // <2>

// then
assertEquals(losAngeles.toLocalDateTime(), seoul.toLocalDateTime());
----
<1> 출력 결과: _2017-10-18T09:00-07:00[America/Los_Angeles]_
<2> 출력 결과: _2017-10-18T09:00+09:00[Asia/Seoul]_ 

=== 특정 시간 기준으로 1주일 지난 시간 구하기

예를 들어, Santiago에서 2018년 5월 10일 10시 기준으로 7주일 이후에 회의를 잡으려고 한다. 이 경우에는 `Period.ofDays(int)` 을 사용한다.

[source, java]
----
// santiago 2018/05/13 00:00:00 이후로 DST 적용
final ZonedDateTime now = ZonedDateTime.of(2018, 5, 10, 10, 0, 0, 0, ZoneId.of("America/Santiago"));
final ZonedDateTime nextMeeting = now.plus(Period.ofDays(7));

System.out.println(now);
System.out.println(nextMeeting);
----

[source]
----
2018-05-10T10:00-03:00[America/Santiago]
2018-05-17T10:00-04:00[America/Santiago]
----

만약 `Duration` 을 사용했다면 Santiago의 DST가 적용되지 잘못된 시간에 회의를 예약하게 된다.

[source, java]
----
final ZonedDateTime nextMeeting = now.plus(Duration.ofDays(7));
System.out.println(nextMeeting);
----

[source]
----
2018-05-17T09:00-04:00[America/Santiago]
----

== 더 알아볼 것

- 왜 타임존 업데이트가 되지 않았는가?
- java 타임존을 업데이트 하는 방법 - oracle jdk, openjdk

== 타임존 DB 업데이트하기

TODO

== 추가 정보

=== `Europe/Istanbul` 타임존

* 터키는 타임존을 사용하지 않는다.
** 사용중인 타임존: https://www.timeanddate.com/time/zone/turkey/istanbul
** 사용하지 않는 타임존: https://www.timeanddate.com/time/zone/turkey
* `Europe/Istanbul` 사용함
* `ZoneId.of("Turkey")` 은 Deprecated. https://en.wikipedia.org/wiki/List_of_tz_database_time_zones[wiki]
* Tzdata 버전은 tzdata2016g이 반영되야함. https://www.oracle.com/technetwork/java/javase/tzdata-versions-138805.html[오라클 문서]
* https://stackoverflow.com/questions/40400793/java-timezone-in-turkey-rejected-daylight-saving

== References

++++
<details><summary>참고 링크</summary>
++++

* https://www.timeanddate.com/time/time-zones.html[What is a Time Zone?]
* https://www.timeanddate.com/time/utc-abbreviation.html[Why is it Called UTC - not CUT?]
* https://www.timeanddate.com/time/dst/[Daylight Saving Time - DST - Summer Time]
* https://www.timeanddate.com/time/dst/summer-time.html[Summer Time Is Daylight Saving Time]
* https://www.timeanddate.com/time/gmt-utc-time.html[The Difference Between GMT and UTC]
* https://ko.wikipedia.org/wiki/시간대[위키피디아 - 시간대]
* https://greenwichmeantime.com/what-is-gmt/[What is Greenwich Mean Time (GMT)?]
* https://docs.oracle.com/javase/8/docs/api/java/time/ZoneId.html[Java Docs - Class ZoneId]
* http://d2.naver.com/helloworld/645609[Java의 날짜와 시간 API - Naver D2]
* https://www.mkyong.com/java/java-convert-date-and-time-between-timezone/[Java 8 이전 버전에서 시간 다루기]
* http://meetup.toast.com/posts/125[자바스크립트에서 타임존 다루기 (1) - Toast]
* https://javarevisited.blogspot.com/2015/03/20-examples-of-date-and-time-api-from-Java8.html[Java 8 Date Time - 20 Examples of LocalDate, LocalTime, LocalDateTime]
* https://jekalmin.tistory.com/entry/%EC%9E%90%EB%B0%94-18-%EB%82%A0%EC%A7%9C-%EC%A0%95%EB%A6%AC[Java 1.8 날짜 정리]

++++
</details>
++++