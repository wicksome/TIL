<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta lang="en" name="description" content="Online simple JSON formatter">
    <meta lang="en" name="keywords"
          content="JSON Formatter &amp; Validator,JSON Validator,JSON Formatter,JSON Format,Debug JSON,Pretty Print JSON,Validate JSON,JSON Pretty Printer,JSON Beautifier,Beautify JSON">
    <meta property="og:title" content="JSON Formatter">
    <meta property="og:description" content="simple json formatter">

    <title>JSON Formatter</title>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2402079508512433"
            crossorigin="anonymous"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D2YELTQV0T"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-D2YELTQV0T');
    </script>

    <!-- naver -->
    <meta name="naver-site-verification" content="19e1704de71915e3321e6c7b25780884d9f96975"/>

    <!-- https://ace.c9.io/ -->
    <link href="https://cdn.jsdelivr.net/npm/ace-builds@1.17.0/css/ace.min.css" rel="stylesheet">

    <!-- Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,200;1,200&display=swap"
          rel="stylesheet">

    <style>
        html {
            /*font-family: 'JetBrains Mono', monospace;*/
            /*font-size: 1rem;*/
        }

        html, body {
            height: 100%;
        }

        main > .container-fluid {
            padding: 60px 15px 0;
        }

        .buttons {
            margin-top: 6px;
            margin-bottom: 10px;
        }

        .buttons > .col > *:not(:last-child) {
            margin-left: 3px;
        }

        .json-query-wrapper {
            --variable: 100px;
            width: calc(100% - var(--variable));
        }

        .json-query-wrapper > input[type='text'] {
            /*width: 400px;*/
            white-space: pre;
        }

        .editor {
            height: 100%;
            display: flex;
            width: 100%;
        }

        .editor-view {
            display: flex;
            width: 100%
        }

        .vertical-area {
            height: calc(100vh - 7rem);
            max-height: 100%;
            width: 100%;
        }

        .editor-view > .editor:first-child {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: 50%;
        }

        .editor-view > .editor:last-child {
            flex-grow: 0;
            flex-shrink: 1;
            overflow-x: auto;
        }

        .editor-view > .resizer {
            flex-grow: 0;
            flex-shrink: 0;
            max-width: 15px;
            cursor: ew-resize;

            /* vertical center text */
            display: flex;
            justify-content: center;
            align-items: center;

            /* disable selection */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }

        .resizer:hover {
            background-color: lightgray;
        }

        .resizer:active {
            background-color: lightgray;
        }

        .log-toast {
            z-index: 10;
            margin-bottom: 10px;
            margin-right: 10px;
        }

        .ts-history-layer {
            /*width: 100%;*/
            z-index: 9;
            height: min-content;
        }

        .ts-history-fold {
            width: 100%;
            padding: 0 10px 0 10px;
            border: 1px solid darkgray;
            background-color: lightgray;
            cursor: move;
        }

        .ts-history-fold-title {
            font-weight: bold;
            padding-right: 20px;
        }

        .ts-history-fold-close:after {
            display: inline-block;
            content: "\00d7"; /* This will render the 'X' */
        }

        .ts-history-wrapper {
            max-height: 150px;
            overflow-y: scroll;
            overflow-x: hidden;
            border-top: 1px solid #000;
            overflow-anchor: none;
        }

        .ts-history {
            background: #e9e9e9;
            display: table;
            border: 1px solid #ccc;
            border-collapse: collapse;
            width: 100%;
        }

        .ts-history-row {
            display: table-row;
            font-size: 13px;
        }

        .ts-history-row:after {
            display: table-cell;
            padding: 3px 6px;
            color: rgba(0, 0, 0, .35);
            border: 1px solid #ccc;
            content: attr(data-date);
            vertical-align: top;
        }

        .ts-history-row + .ts-history-row > * {
            border: 1px solid #ccc;
        }

        .ts-history-row:last-child, .ts-history-row:last-child:after {
            animation: flash 1s;
        }

        .ts-history-row > div {
            padding: 3px 5px;
            white-space: pre-wrap;
            display: table-cell;
            vertical-align: middle;
        }

        @keyframes flash {
            0% {
                background: rgba(255, 240, 0, .25);
            }
            100% {
                background: none;
            }
        }
    </style>
</head>
<body class="d-flex flex-column h-100">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Tools</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
                aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">JSON Formatter</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://wickso.me/tools/json-diff">JSON Diff</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                       aria-expanded="false">
                        Others
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="https://wickso.me/tools/emoji-converter">Emoji Converter</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
<main>
    <div class="container-fluid">
        <div class="contents">
            <div class="row clearfix buttons">
                <div class="col float-start">
                    <button type="button" class="btn btn-light" id="copy">copy result</button>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="checkbox" id="sortJson">
                        <label class="form-check-label" for="sortJson">sort</label>
                    </div>
                </div>
                <div class="col float-end">
                    <button type="button" class="btn btn-light float-end" data-bs-toggle="collapse"
                            data-bs-target="#setting"
                            aria-expanded="false" aria-controls="setting">
                        settings
                    </button>
                    <div class="float-end json-query-wrapper">
                        <input id="jsonQuery" type="text" class="form-control" placeholder="jsonata expression">
                    </div>
                </div>
            </div>
            <div class="collapse" id="setting">
                <div class="card-group">
                    <div class="card">
                        <div class="card-body">
                            <div>
                                <label for="editorLineWrap">wrap: </label>
                                <input type="checkbox" id="editorLineWrap">
                            </div>
                            <div>fontSize:
                                <button type="button" class="btn btn-dark btn-sm" id="sizeUpJsonFont">+</button>
                                <button type="button" class="btn btn-dark btn-sm" id="sizeDownJsonFont">-</button>
                                <button type="button" class="btn btn-warning btn-sm" id="resetJsonFont">reset
                                </button>
                            </div>
                            <div>
                                <label for="showTimestampConvertLayer">show timestamp converter: </label>
                                <input type="checkbox" id="showTimestampConvertLayer" checked>
                            </div>
                            <div>
                                <label for="showRelativeTimeColumn">show relative time column: </label>
                                <input type="checkbox" id="showRelativeTimeColumn">
                            </div>
                            <div>
                                <label for="showEpochSecondColumn">show epoch second column: </label>
                                <input type="checkbox" id="showEpochSecondColumn">
                            </div>
                            <div>
                                <label for="showEpochMilliSecondColumn">show epoch millisecond column: </label>
                                <input type="checkbox" id="showEpochMilliSecondColumn">
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div>
                                <span>more editor settings: click the editor, <code>cmd</code> + <code>,</code></span>
                            </div>
                            <div>
                                <span>more editor actions: click the editor, <code>f1</code></span>
                            </div>
                            <div>
                                <span>JSONata expression guide: <a
                                        href="https://docs.jsonata.org/simple">link</a></span>
                                <div class="card card-body"
                                     style="padding: 10px 15px; color: inherit; text-decoration: none;">
                                    <span>func: <code>$distinct(Property)</code>, <code>$sum(Property)</code></span>
                                    <span>array func: <code>$sort(Array)</code>, <code>$count(Array)</code></span>
                                    <span>filter: <code>Property[SubProperty='Value']</code></span>
                                    <span>wildcard: <code>Property.*</code> (<a
                                            href="https://docs.jsonata.org/predicate#wildcards">#</a>)</span>
                                    <span>concat: <code>Property.(SubProperty & '=' & SubProperty)</code> (<a
                                            href="https://docs.jsonata.org/expressions#string-expressions">#</a>)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br/>
            </div>

            <div class="row editor-container">
                <div class="editor-view">
                    <div class="editor">
                        <div id="inputEditor" class="vertical-area"></div>
                    </div>
                    <div class="resizer" id="editorResizer">︙</div>
                    <div class="editor refresh-effect-area">
                        <div id="resultEditor" class="vertical-area"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>
<div class="position-absolute bottom-0 ts-history-layer">
    <div class="ts-history-fold" data-bs-toggle="collapse" data-bs-target="#navbarToggleExternalContent"
         aria-controls="navbarToggleExternalContent" aria-expanded="false">
        <span class="ts-history-fold-title">Epoch timestamp converter</span>
        <span class="float-end ts-history-fold-close" role="button"></span>
    </div>
    <div class="collapse show ts-history-wrapper" id="navbarToggleExternalContent-disable">
        <div class="ts-history">
            <div class="ts-history-row" data-date="created_at">
                <div>Input</div>
                <div>UTC</div>
                <div id="currentTimeZone"></div>
                <div class="ts-col-1" style="display: none">Relative</div>
                <div class="ts-col-2" style="display: none">Epoch(s)</div>
                <div class="ts-col-3" style="display: none">Epoch(ms)</div>
            </div>
        </div>
    </div>
</div>
<div class="position-absolute bottom-0 end-0 border-0 log-toast">
    <div class="toast align-items-center" role="alert" aria-live="polite" aria-atomic="true" id="toastBody">
        <div class="d-flex">
            <div class="toast-body" id="toastContent"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/ace-builds@1.17.0/src-min-noconflict/ace.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8gI4ddQ3GYNS7NTKfAdVQSZe"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/lossless-json@2.0.9/lib/umd/lossless-json.min.js"></script>
<script src="dragmove.js"></script>
<script src="json-sort.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jsonata/jsonata.min.js"></script>

<script>
    const deepSort = sort

    // editor
    let inputEditor = undefined
    let resultEditor = undefined

    // initialize editors
    const initEditorInstances = () => {
        inputEditor = ace.edit("inputEditor");
        inputEditor.setTheme("ace/theme/dawn");
        inputEditor.session.setMode("ace/mode/json");

        resultEditor = ace.edit("resultEditor");
        resultEditor.setTheme("ace/theme/dawn");
        resultEditor.session.setMode("ace/mode/json");
        resultEditor.session.setUseWorker(false)
        resultEditor.setShowPrintMargin(false)
        resultEditor.setReadOnly(true)

        const latestJsonContent = getSetting("latestJsonContent")
        if (!!latestJsonContent) {
            inputEditor.setValue("")
            inputEditor.insert(latestJsonContent) // call input event
        }
        console.log("init editor instances", [inputEditor, resultEditor])
    }

    const getCurrentEditorOptions = () => {
        const defaultOptions = {
            fontFamily: "JetBrains Mono",
            fontSize: 12,
            wrap: null,
            tabSize: 2,
            useSoftTabs: false,
            showInvisibles: false,
        }
        const savedEditorOptionsStr = getSetting("editorOptions")

        let savedEditorOptions = {}
        if (!!savedEditorOptionsStr) {
            savedEditorOptions = JSON.parse(savedEditorOptionsStr)
        }
        const currentOptions = JSON.parse(JSON.stringify(defaultOptions))

        return Object.assign(currentOptions, savedEditorOptions)
    }

    const initEditorOptions = () => {
        if (!inputEditor || !resultEditor) {
            console.error("not yet init editor")
            return
        }

        const defaultOptions = getCurrentEditorOptions()
        updateEditorOptions(defaultOptions)

        // apply editor setting
        document.querySelector("#editorLineWrap").checked = defaultOptions.wrap
        document.querySelector("#sortJson").checked = getSetting("sortJson")

        const editorWidth = getSetting("latestInputEditorWidth")
        if (!!editorWidth) {
            document.querySelector(".editor-view > .editor:first-child").style.flexBasis = editorWidth
        }
    }

    const updateEditorOptions = (options) => {
        if (!inputEditor || !resultEditor) {
            console.error("not yet init editor")
            return
        }

        // validate
        if (!!options.fontSize && (options.fontSize < 10 || options.fontSize > 100)) {
            console.warn("fontSize min: 10, max: 100")
            return
        }

        const currentOptions = getCurrentEditorOptions()
        const updateOptions = JSON.parse(JSON.stringify(currentOptions))
        if (!!options) {
            Object.assign(updateOptions, options)
        }

        inputEditor.setOptions(updateOptions)
        resultEditor.setOptions(updateOptions)
        setSetting("editorOptions", JSON.stringify(updateOptions))

        console.log("updated editor options", updateOptions)
    }

    // etc options
    const getSetting = (key) => {
        if (key === "sortJson") {
            const sortJson = localStorage.getItem("sortJson")
            return (sortJson === null) ? false : /^true$/i.test(sortJson)
        }

        if (key === "latestJsonContent") {
            return localStorage.getItem("latestJsonContent")
        }

        if (key === "editorOptions") {
            return localStorage.getItem("editorOptions")
        }

        if (key === "latestInputEditorWidth") {
            return localStorage.getItem("latestInputEditorWidth")
        }

        throw Error(`not supported option: ${key}`)
    }

    const setSetting = (key, value) => {
        localStorage.setItem(key, value)
    }

    const removeSetting = (key) => {
        localStorage.removeItem(key)
    }

    // json formatter
    let temp = ""
    const format = async (content, expression, options = {
        force: false,
        sort: false,
    }) => {
        if (!options.force && temp === content) return

        console.log("--------------------------------------------------------")
        console.log("input", content)
        console.log("expression", expression)
        console.log("options", options)
        console.log("........................................................")

        // 1. json formatting
        let result
        try {
            let jsonResult = LosslessJSON.parse(content)
            console.log("input(json)", jsonResult)
            if (options.sort) {
                console.log("sort!")
                jsonResult = deepSort(jsonResult)
            }

            result = LosslessJSON.stringify(jsonResult, undefined, 2)
        } catch (e) {
            throw e
        }
        console.log("result(format)", result)
        // result = Promise.resolve(result)

        // 2. json filtering
        let filtered
        if (!!expression && expression.trim().length > 0) {
            // https://docs.jsonata.org/string-functions
            const jsonataExp = jsonata(expression)
            const jsonataResult = await jsonataExp.evaluate(JSON.parse(result))

            filtered = JSON.stringify(jsonataResult, undefined, 2)
            console.log("result(filter)", filtered)

            // [references]
            // https://try.jsonata.org/
            // https://maxleiko.github.io/json-query-tester/
            // https://mwh.github.io/jqjs/demo.html
        }

        temp = content

        // TODO: return null when no change
        if (!!expression) {
            return filtered
        }

        return result
    }
    const showAlert = (message) => {
        document.querySelector("#toastContent").innerHTML = message
        const toastBody = bootstrap.Toast.getOrCreateInstance(document.getElementById('toastBody'))
        toastBody.show()
    }

    let refreshTimer
    const effectRefersh = () => {
        // update effect
        clearTimeout(refreshTimer)
        const area = document.querySelector(".refresh-effect-area")
        area.style.outline = "solid rgb(85, 255, 0) 2px"
        refreshTimer = setTimeout(() => {
            area.style.outline = "unset"
        }, 220)
    }
    const runFormat = (options) => {
        const force = options == null ? false : (!!options.force ? options.force : false)
        format(
            inputEditor.getValue(),
            document.querySelector("#jsonQuery").value,
            {
                sort: getSetting("sortJson"),
                force: force,
            }
        ).then((result) => {
            // set result
            console.log(result)
            if (!!result) {
                resultEditor.setValue("")
                resultEditor.insert(result)

                // update effect
                effectRefersh()
            }
        }).catch((e) => {
            console.warn(e)
            showAlert(`⚠️ ${e.message}`)
            return undefined
        }).finally(() => {
            setSetting("latestJsonContent", inputEditor.getValue())
        })
    }

    function formatTimeAgo(date) {
        const formatter = new Intl.RelativeTimeFormat('ko-kr', {
            numeric: 'auto'
        })

        const DIVISIONS = [
            {amount: 60, name: 'seconds'},
            {amount: 60, name: 'minutes'},
            {amount: 24, name: 'hours'},
            {amount: 7, name: 'days'},
            {amount: 4.34524, name: 'weeks'},
            {amount: 12, name: 'months'},
            {amount: Number.POSITIVE_INFINITY, name: 'years'}
        ]

        let duration = (date - new Date()) / 1000

        for (let i = 0; i < DIVISIONS.length; i++) {
            const division = DIVISIONS[i]
            if (Math.abs(duration) < division.amount) {
                return formatter.format(Math.round(duration), division.name)
            }
            duration /= division.amount
        }
    }

    let rows = []
    const appendRow = (input, date) => {
        const now = (new Date()).toTimeString().split(' ')[0]

        // TODO: https://dkje.github.io/2020/08/18/createDomElement/#3-document-fragment
        let row
        try {
            const showColumn1 = document.querySelector("#showRelativeTimeColumn").checked ? "table-cell" : "none"
            const showColumn2 = document.querySelector("#showEpochSecondColumn").checked ? "table-cell" : "none"
            const showColumn3 = document.querySelector("#showEpochMilliSecondColumn").checked ? "table-cell" : "none"

            row = `<div class="ts-history-row" data-date="${now}">
                    <div>${input}</div>
                    <div>${date.toISOString()}</div>
                    <div>${date.toLocaleString()}</div>
                    <div class="ts-col-1" style="display: ${showColumn1}">${formatTimeAgo(date)}</div>
                    <div class="ts-col-2" style="display: ${showColumn2}">${date.getTime() / 1000}</div>
                    <div class="ts-col-3" style="display: ${showColumn3}">${date.getTime()}</div>
                </div>`.trim()
        } catch (e) {
            console.warn(`input: [${input}], date: [${date}] throw: ${e}`)
            return
        }

        const lastRow = rows[rows.length - 1]
        if (input === lastRow) {
            console.log("duplicate last value")
            return
        }
        rows.push(input)

        // set scroll to bottom
        document.querySelector(".ts-history").innerHTML += row
        const element = document.querySelector(".ts-history-wrapper")
        element.scroll({top: element.scrollHeight, behavior: 'smooth'});
    }
    const appendTimeStamp = (editor) => {
        setTimeout(() => {
            const value = toNumber(editor.getSelectedText().trim())
            if (!value) return

            // convert epoch millisecond or second to date
            let date = new Date(value)
            if (Math.abs(Date.now() - date) < Math.abs(Date.now() - date * 1000)) {
                // epoch millisecond
                date = new Date(value)
            } else {
                // epoch second
                date = new Date(value * 1000)
            }

            appendRow(value, date)
        }, 10);
    }

    const debounce = (callback, limit = 100) => {
        let timeout
        return function (...args) {
            clearTimeout(timeout)
            timeout = setTimeout(() => {
                callback.apply(this, args)
            }, limit)
        }
    }

    const toNumber = (value) => {
        if (!value || !/^\d+$/.test(value)) return null
        return parseInt(value)
    }

    const isIsoDate = (str) => {
        try {
            // https://stackoverflow.com/a/37563868/3793078
            const ISO_8601 = /^\d{4}(-\d\d(-\d\d(T\d\d:\d\d(:\d\d)?(\.\d+)?(([+-]\d\d:\d\d)|Z)?)?)?)?$/i

            if (ISO_8601.test(str)) {
                new Date(Date.parse(str));
                return true
            } else {
                return false
            }
        } catch (e) {
            return false
        }
    }

    // ===================================================
    // event listeners
    // ===================================================
    document.addEventListener('DOMContentLoaded', () => {
        // TODO: clear datetime rows
        // TODO: delete row converted datetime
        // TODO: fix header in datetime table to top
        // TODO: support big number when filtering json
        // TODO: set auto width sizing of json query input

        initEditorInstances()
        initEditorOptions()

        // https://github.com/daybrush/moveable
        // https://github.com/knadh/dragmove.js
        dragmove(document.querySelector(".ts-history-layer"), document.querySelector(".ts-history-fold"));

        // set current timezone
        document.querySelector("#currentTimeZone").innerHTML = Intl.DateTimeFormat().resolvedOptions().timeZone

        // add default value in editor
        inputEditor.on("input", () => {
            runFormat()
        })
        inputEditor.session.selection.on("changeSelection", debounce((e) => {
            const selection = inputEditor.getSelectedText()
            if (!selection) return

            const timestamp = toNumber(selection)
            if (!!timestamp) {
                appendTimeStamp(inputEditor)
                return
            }

            const str = selection
                .replaceAll('"', '')
                .trim()

            if (isIsoDate(str)) {
                appendRow(str, new Date(Date.parse(str)))
                return
            }
        }, 500))
        resultEditor.session.selection.on("changeSelection", debounce((e) => {
            const selection = resultEditor.getSelectedText()
            if (!selection) return

            const timestamp = toNumber(selection)
            if (!!timestamp) {
                appendTimeStamp(resultEditor)
                return
            }

            const str = selection.replaceAll('"', '')
            if (isIsoDate(str)) {
                appendRow(str, new Date(Date.parse(str)))
                return
            }
        }, 500))
        inputEditor.on("dblclick", () => {
            appendTimeStamp(inputEditor)
        });
        resultEditor.on("dblclick", () => {
            appendTimeStamp(resultEditor)
        });

        // add dom events
        const $copy = document.querySelector("#copy")
        const $sortJson = document.querySelector("#sortJson")
        const $resizer = document.querySelector("#editorResizer")
        const $editor = document.querySelector(".editor-view > .editor:first-child")
        const $fontSizeUp = document.querySelector("#sizeUpJsonFont")
        const $fontSizeDown = document.querySelector("#sizeDownJsonFont")
        const $fontSizeReset = document.querySelector("#resetJsonFont")
        const $editorLineWrap = document.querySelector("#editorLineWrap")

        const $converterColumn1 = document.querySelector("#showRelativeTimeColumn")
        const $converterColumn2 = document.querySelector("#showEpochSecondColumn")
        const $converterColumn3 = document.querySelector("#showEpochMilliSecondColumn")

        $copy.addEventListener("click", (e) => {
            const content = resultEditor.getValue()
            if (content.trim() === "") return

            navigator.clipboard.writeText(content).then(() => {
                const beforeLabel = $copy.textContent
                const beforeClass = [...$copy.classList].find((cls) => {
                    return !!cls.match(/btn-\w+/)
                })
                $copy.classList.remove(beforeClass)
                $copy.classList.add("btn-success")
                $copy.textContent = "copied!"
                setTimeout(() => {
                    $copy.classList.remove("btn-success")
                    $copy.classList.add(beforeClass)
                    $copy.textContent = beforeLabel
                }, 500)
            })
            $resizer.addEventListener("click", (e) => {
                console.log(e.clientX, e.clientY)
            })
        })

        $sortJson.addEventListener("change", (e) => {
            setSetting("sortJson", e.target.checked)

            runFormat({force: true})
        })
        document.querySelector("#jsonQuery").addEventListener("input", (e) => {
            runFormat({force: true})
        })

        // resizing editor width size
        const RESIZING_DIV_WIDTH = 15 // px
        const resize = (e) => {
            let clientX = e.clientX
            if (!clientX) {
                // support touch event
                if (!e.touches || e.touches.length === 0) {
                    console.warn("not found event.touches")
                    return
                }
                clientX = e.touches[0].clientX
            }
            const width = (clientX - (RESIZING_DIV_WIDTH + (RESIZING_DIV_WIDTH / 2)))

            const $el = document.querySelector(".editor-view")
            const style = $el.currentStyle || window.getComputedStyle($el)
            const maxWidth = $el.clientWidth - RESIZING_DIV_WIDTH - parseInt(style.paddingLeft) - parseInt(style.paddingRight)
            if (width < 0 || width >= maxWidth) {
                console.warn(`can not less then 0 or grete then ${maxWidth}`)
                return
            }

            $editor.style.flexBasis = `${width}px`
            setSetting("latestInputEditorWidth", `${width}px`)
        }
        $resizer.addEventListener("mousedown", (e) => {
            if (e.offsetX < RESIZING_DIV_WIDTH) {
                document.addEventListener("mousemove", resize, false)
            }
        }, false);
        document.addEventListener("mouseup", (e) => {
            document.removeEventListener("mousemove", resize, false)
        }, false);
        $resizer.addEventListener("dblclick", (e) => {
            $editor.style.removeProperty("flex-basis")
            removeSetting("latestInputEditorWidth")
            console.log("reset editor width")
        });
        $resizer.addEventListener("touchstart", (e) => {
            document.addEventListener("touchmove", resize, false)
        }, false);
        document.addEventListener("touchend", (e) => {
            document.removeEventListener("touchmove", resize, false)
        }, false);

        // font size events
        $fontSizeUp.addEventListener("click", (e) => {
            const size = parseInt(inputEditor.getFontSize()) + 1
            updateEditorOptions({fontSize: size})
        })
        $fontSizeDown.addEventListener("click", (e) => {
            const size = parseInt(inputEditor.getFontSize()) - 1
            updateEditorOptions({fontSize: size})
        })
        $fontSizeReset.addEventListener("click", (e) => {
            updateEditorOptions({fontSize: null})
        })

        // etc options
        $editorLineWrap.addEventListener("change", (e) => {
            let enable = null
            if (e.target.checked) enable = true
            updateEditorOptions({wrap: enable})
        })

        $converterColumn1.addEventListener("change", (e) => {
            const display = e.target.checked ? "table-cell" : "none"
            document.querySelectorAll(".ts-col-1").forEach(e => e.style.display = display)
        })

        $converterColumn2.addEventListener("change", (e) => {
            const display = e.target.checked ? "table-cell" : "none"
            document.querySelectorAll(".ts-col-2").forEach(e => e.style.display = display)
        })

        $converterColumn3.addEventListener("change", (e) => {
            const display = e.target.checked ? "table-cell" : "none"
            document.querySelectorAll(".ts-col-3").forEach(e => e.style.display = display)
        })

        document.querySelector("#showTimestampConvertLayer").addEventListener("change", (e) => {
            const display = e.target.checked ? "block" : "none"
            document.querySelector(".ts-history-layer").style.display = display
        })

        document.querySelector(".ts-history-fold-close").addEventListener("click", (e) => {
            document.querySelector("#showTimestampConvertLayer").click()
        })
    }, false);
</script>
</body>
</html>
