<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta lang="en" name="description" content="Online simple JSON formatter">
    <meta lang="en" name="keywords"
          content="JSON Formatter &amp; Validator,JSON Validator,JSON Formatter,JSON Format,Debug JSON,Pretty Print JSON,Validate JSON,JSON Pretty Printer,JSON Beautifier,Beautify JSON">
    <meta property="og:title" content="JSON Formatter">
    <meta property="og:description" content="simple json formatter">

    <title>JSON Formatter</title>

    <!-- Google Adsense -->
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2402079508512433"
            crossorigin="anonymous"></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-D2YELTQV0T"></script>
    <script>
        window.dataLayer = window.dataLayer || [];

        function gtag() {
            dataLayer.push(arguments);
        }

        gtag('js', new Date());

        gtag('config', 'G-D2YELTQV0T');
    </script>

    <!-- naver -->
    <meta name="naver-site-verification" content="19e1704de71915e3321e6c7b25780884d9f96975"/>

    <!-- https://ace.c9.io/ -->
    <link href="https://fastly.jsdelivr.net/npm/ace-builds@1.33.1/css/ace.min.css" rel="stylesheet">

    <!-- Bootstrap-->
    <link href="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,200;1,200&display=swap"
          rel="stylesheet">

    <style>
        main {
            height: 100vh;
        }

        main > .container-fluid {
            height: 100%;
            padding: 60px 15px 0;
        }

        .buttons {
            margin-top: 6px;
            margin-bottom: 10px;
        }

        .buttons > .col > *:not(:last-child) {
            margin-left: 3px;
        }

        .json-size {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
        }

        .json-size-value {
            font-size: small;
        }

        .json-query-wrapper {
            --variable: 50px;
            width: calc(100% - var(--variable));
        }

        .json-query-wrapper > input[type='text'] {
            /*width: 400px;*/
            white-space: pre;
        }

        .json-history-wrapper {
            height: 300px;
        }

        .json-history-wrapper > div,
        .json-history-wrapper > div > div {
            height: 100%;
        }

        .json-history-list {
            height: calc(100% - 25px);
            overflow: scroll;
            -webkit-overflow-scrolling: touch;
            /*padding-top: 10px;*/
        }

        .json-history-list-row {
            cursor: pointer;
        }

        .json-history-row-title {
            /*white-space: nowrap;*/
            /*overflow: hidden;*/
            /*text-overflow: ellipsis;*/
        }

        .json-history-row-buttons > button {
            --bs-btn-padding-y: .3rem;
            --bs-btn-padding-x: .4rem;
            --bs-btn-font-size: .5rem;
        }

        .json-history-editor {
            height: calc(100% - 25px);
        }

        .contents {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .editor-container {
            flex-grow: 1;
        }

        .editor-view {
            display: flex;
            width: 100%
        }

        .editor {
            height: 100%;
            display: flex;
            width: 100%;
            padding-bottom: 5px;
        }

        .vertical-area {
            height: 100%;
            width: 100%;
        }

        .editor-view > .editor:first-child {
            flex-grow: 1;
            flex-shrink: 0;
            flex-basis: 50%;
        }

        .editor-view > .editor:last-child {
            flex-grow: 0;
            flex-shrink: 1;
            overflow-x: auto;
        }

        .editor-view > .resizer {
            flex-grow: 0;
            flex-shrink: 0;
            max-width: 15px;
            cursor: ew-resize;

            /* vertical center text */
            display: flex;
            justify-content: center;
            align-items: center;

            /* disable selection */
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
        }

        .resizer:hover {
            background-color: lightgray;
        }

        .resizer:active {
            background-color: lightgray;
        }

        .log-toast {
            z-index: 10;
            margin-bottom: 10px;
            margin-right: 10px;
        }

        .toast-body {
            /*white-space: nowrap;*/
            overflow: hidden;
            /*text-overflow: ellipsis;*/
        }

        .ts-history-layer {
            /*width: 100%;*/
            z-index: 9;
            height: min-content;
        }

        .ts-history-fold {
            width: 100%;
            padding: 0 10px 0 10px;
            border: 1px solid darkgray;
            background-color: lightgray;
            cursor: move;
        }

        .ts-history-fold-title {
            font-weight: bold;
            padding-right: 20px;
        }

        .ts-history-fold-close:after {
            display: inline-block;
            content: "\00d7"; /* This will render the 'X' */
        }

        .ts-history-wrapper {
            max-height: 150px;
            /* overflow-y: scroll; */
            overflow-x: hidden;
            border-top: 1px solid #000;
            overflow-anchor: none;
        }

        .ts-history {
            background: #e9e9e9;
            display: table;
            border: 1px solid #ccc;
            border-collapse: collapse;
            width: 100%;
        }

        .ts-history-row {
            display: table-row;
            font-size: 13px;
            pointer-events: none;
        }

        .ts-history-row:after {
            display: table-cell;
            padding: 3px 6px;
            color: rgba(0, 0, 0, .35);
            border: 1px solid #ccc;
            content: attr(data-date);
            vertical-align: top;
            pointer-events: all;
        }

        .ts-history-row > div {
            border: 1px solid #ccc;
        }

        .ts-history-row:not(:first-child):hover:after {
            content: "\00d7"; /* This will render the 'X' */
            color: red;
            font-weight: bold;
        }

        .ts-history-row:last-child, .ts-history-row:last-child:after {
            animation: flash 1s;
        }

        .ts-history-row > div {
            padding: 3px 5px;
            white-space: pre-wrap;
            display: table-cell;
            vertical-align: middle;
        }

        @keyframes flash {
            0% {
                background: rgba(255, 240, 0, .25);
            }
            100% {
                background: none;
            }
        }
    </style>
</head>
<body class="d-flex flex-column h-100">
<nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">Tools</span>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
                aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="#">JSON Formatter</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="https://wickso.me/tools/json-diff">JSON Diff</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown"
                       aria-expanded="false">
                        Others
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="https://wickso.me/tools/emoji-converter">Emoji Converter</a>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>
<main>
    <div class="container-fluid">
        <div class="contents">
            <div class="row clearfix buttons">
                <div class="col float-start">
                    <button type="button" class="btn btn-light position-relative" id="toggleJsonHistoryArea"
                            data-bs-toggle="collapse"
                            data-bs-target="#jsonHistoryArea"
                            aria-expanded="false" aria-controls="jsonHistoryArea">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                             class="bi bi-star" viewBox="0 0 16 16">
                            <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.565.565 0 0 0-.163-.505L1.71 6.745l4.052-.576a.525.525 0 0 0 .393-.288L8 2.223l1.847 3.658a.525.525 0 0 0 .393.288l4.052.575-2.906 2.77a.565.565 0 0 0-.163.506l.694 3.957-3.686-1.894a.503.503 0 0 0-.461 0z"/>
                        </svg>
                        <span class="badge rounded-pill text-bg-primary" id="jsonHistoryCount"
                              style="display: none;">0</span>
                        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle new-feature">
                            <span class="visually-hidden">New features</span>
                        </span>
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-light dropdown-toggle" data-bs-toggle="dropdown"
                                aria-expanded="false">
                            Tools
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" id="minify">minify</a></li>
                            <li><a class="dropdown-item" href="#" id="escape">escape</a></li>
                            <li><a class="dropdown-item" href="#" id="unescape">unescape</a></li>
                        </ul>
                    </div>
                    <button type="button" class="btn btn-light" id="copy">copy result</button>
                    <!--                    <div class="form-check form-check-inline">-->
                    <!--                        <input class="form-check-input" type="checkbox" id="sortJson">-->
                    <!--                        <label class="form-check-label" for="sortJson">Sort</label>-->
                    <!--                    </div>-->
                    <input type="checkbox" class="btn-check" id="sortJson" autocomplete="off">
                    <label class="btn btn-outline-success" for="sortJson">sort</label>
                    <div class="float-end json-size">
                        <span class="json-size-value" id="jsonSizeValue"></span>
                    </div>
                </div>
                <div class="col float-end">
                    <button type="button" class="btn btn-light position-relative float-end" data-bs-toggle="collapse"
                            data-bs-target="#setting"
                            aria-expanded="false" aria-controls="setting">
                        <i class="bi bi-tools"></i>
                        <span class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle new-feature">
                            <span class="visually-hidden">New features</span>
                        </span>
                    </button>
                    <div class="float-end json-query-wrapper">
                        <textarea id="jsonQuery" type="text" class="form-control" placeholder="jsonata expression"
                                  rows="1" style="tab-size: 4;"></textarea>
                    </div>
                </div>
            </div>
            <div class="collapse" id="setting">
                <div class="card-group">
                    <div class="card">
                        <div class="card-body">
                            <h5>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-window-split" viewBox="0 0 16 16">
                                    <path d="M2.5 4a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm2-.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Zm1 .5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Z"/>
                                    <path d="M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2Zm12 1a1 1 0 0 1 1 1v2H1V3a1 1 0 0 1 1-1h12ZM1 13V6h6.5v8H2a1 1 0 0 1-1-1Zm7.5 1V6H15v7a1 1 0 0 1-1 1H8.5Z"/>
                                </svg>
                                Editor
                            </h5>
                            <div>font size:
                                <button type="button" class="btn btn-dark btn-sm" id="sizeUpJsonFont">+</button>
                                <button type="button" class="btn btn-dark btn-sm" id="sizeDownJsonFont">-</button>
                                <button type="button" class="btn btn-warning btn-sm" id="resetJsonFont">reset
                                </button>
                                <!--                                <input type="number" min="10" max="100" id="fontSize">-->
                            </div>
                            <div>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-text-wrap" viewBox="0 0 16 16">
                                    <path fill-rule="evenodd"
                                          d="M2 3.5a.5.5 0 0 1 .5-.5h11a.5.5 0 0 1 0 1h-11a.5.5 0 0 1-.5-.5Zm0 4a.5.5 0 0 1 .5-.5h9a2.5 2.5 0 0 1 0 5h-1.293l.647.646a.5.5 0 0 1-.708.708l-1.5-1.5a.5.5 0 0 1 0-.708l1.5-1.5a.5.5 0 0 1 .708.708l-.647.646H11.5a1.5 1.5 0 0 0 0-3h-9a.5.5 0 0 1-.5-.5Zm0 4a.5.5 0 0 1 .5-.5H7a.5.5 0 0 1 0 1H2.5a.5.5 0 0 1-.5-.5Z"/>
                                </svg>
                                <label for="editorLineWrap">wrap: </label>
                                <input type="checkbox" id="editorLineWrap">
                            </div>
                            <hr/>
                            <h5>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-window-split" viewBox="0 0 16 16">
                                    <path d="M2.5 4a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm2-.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Zm1 .5a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Z"/>
                                    <path d="M2 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2H2Zm12 1a1 1 0 0 1 1 1v2H1V3a1 1 0 0 1 1-1h12ZM1 13V6h6.5v8H2a1 1 0 0 1-1-1Zm7.5 1V6H15v7a1 1 0 0 1-1 1H8.5Z"/>
                                </svg>
                                Result View
                            </h5>
                            <div>
                                <label for="includeTimeStampToJsonResult">Include timestamp to result: </label>
                                <input type="checkbox" id="includeTimeStampToJsonResult">
                            </div>
                            <div>
                                <span style="color: #dc3545; font-size: .5rem">●</span>
                                <label for="displayConvertedTimeStamp">Display timestamp converted to
                                    LocalDateTime: </label>
                                <input type="checkbox" id="displayConvertedTimeStamp">
                            </div>
                            <hr/>
                            <h5>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-window-stack" viewBox="0 0 16 16">
                                    <path d="M4.5 6a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1ZM6 6a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1Zm2-.5a.5.5 0 1 1-1 0 .5.5 0 0 1 1 0Z"/>
                                    <path d="M12 1a2 2 0 0 1 2 2 2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2 2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h10ZM2 12V5a2 2 0 0 1 2-2h9a1 1 0 0 0-1-1H2a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1Zm1-4v5a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V8H3Zm12-1V5a1 1 0 0 0-1-1H4a1 1 0 0 0-1 1v2h12Z"/>
                                </svg>
                                TimeStamp Converter
                            </h5>
                            <div>
                                <label for="showTimestampConvertLayer">Show timestamp converter: </label>
                                <input type="checkbox" id="showTimestampConvertLayer" checked>
                            </div>
                            <div>
                                <label for="ignoreDuplicateLastRow">Ignore duplicated last row: </label>
                                <input type="checkbox" id="ignoreDuplicateLastRow">
                            </div>
                            <div>
                                <label for="showRelativeTimeColumn">Add a column(relative time): </label>
                                <input type="checkbox" id="showRelativeTimeColumn">
                            </div>
                            <div>
                                <label for="showEpochSecondColumn">Add a column(epoch second): </label>
                                <input type="checkbox" id="showEpochSecondColumn">
                            </div>
                            <div>
                                <label for="showEpochMilliSecondColumn">Add a column(epoch millisecond): </label>
                                <input type="checkbox" id="showEpochMilliSecondColumn">
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-chat-right-text" viewBox="0 0 16 16">
                                    <path d="M2 1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h9.586a2 2 0 0 1 1.414.586l2 2V2a1 1 0 0 0-1-1H2zm12-1a2 2 0 0 1 2 2v12.793a.5.5 0 0 1-.854.353l-2.853-2.853a1 1 0 0 0-.707-.293H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h12z"/>
                                    <path d="M3 3.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 6a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 6zm0 2.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5z"/>
                                </svg>
                                More
                            </h5>
                            <div>
                                <span>keyboard shortcut: <a
                                        href="https://github.com/ajaxorg/ace/wiki/Default-Keyboard-Shortcuts">link</a></span>
                            </div>
                            <!--                             <div class="shortcut-macos">
                                                            <span>fold: <code class="metakey">cmd</code> + <code>shift</code> + <code>alt</code> + <code>L</code></span>
                                                        </div>
                                                        <div class="shortcut-window">
                                                            <span>fold: <code>alt</code> + <code>L</code></span>
                                                        </div> -->
                            <div>
                                <span>more editor settings: click the editor → <code class="metakey">cmd</code> + <code>,</code></span>
                            </div>
                            <div>
                                <span>more editor actions: click the editor → <code>f1</code></span>
                            </div>
                            <div>
                                <span>JSONata expression guide: <a
                                        href="https://docs.jsonata.org/simple">link</a></span>
                                <div class="card card-body"
                                     style="padding: 10px 15px; color: inherit; text-decoration: none;">
                                    <span>func: <code>$distinct(Property)</code>, <code>$sum(Property)</code>, <code>$substring(Property, 0, 4)</code></span>
                                    <span>array func: <code>$sort(Array)</code>, <code>Array ~> $sort()</code>, <code>$count(Array)</code></span>
                                    <span>filter: <code>Property[SubProperty='Value']</code></span>
                                    <span>wildcard: <code>Property.*</code> (<a
                                            href="https://docs.jsonata.org/predicate#wildcards">#</a>)</span>
                                    <span>concat: <code>Property.(SubProperty & '=' & SubProperty)</code> (<a
                                            href="https://docs.jsonata.org/expressions#string-expressions">#</a>)</span>
                                    <span class="jsonata-example-trigger" data-file-name="jsonata_example_1.png">
                                        more: <code>$sort(Property.array[].{"date": date, "order": order}, function($l, $r) {$l.order < $r.order})</code> (<a
                                            href="assets/jsonata_example_1.png" target="jsonata_preview">#</a>)
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <br/>
            </div>
            <div class="collapse" id="jsonHistoryArea">
                <div class="card-group json-history-wrapper">
                    <div class="card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col float-start">
                                    <h5>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                                             fill="currentColor"
                                             class="bi bi-star" viewBox="0 0 16 16">
                                            <path d="M2.866 14.85c-.078.444.36.791.746.593l4.39-2.256 4.389 2.256c.386.198.824-.149.746-.592l-.83-4.73 3.522-3.356c.33-.314.16-.888-.282-.95l-4.898-.696L8.465.792a.513.513 0 0 0-.927 0L5.354 5.12l-4.898.696c-.441.062-.612.636-.283.95l3.523 3.356-.83 4.73zm4.905-2.767-3.686 1.894.694-3.957a.565.565 0 0 0-.163-.505L1.71 6.745l4.052-.576a.525.525 0 0 0 .393-.288L8 2.223l1.847 3.658a.525.525 0 0 0 .393.288l4.052.575-2.906 2.77a.565.565 0 0 0-.163.506l.694 3.957-3.686-1.894a.503.503 0 0 0-.461 0z"/>
                                        </svg>
                                        Bookmark
                                    </h5>
                                </div>
                                <div class="col float-end">
                                    <button type="button" class="btn btn-light btn-sm float-end" id="AddJsonHistory"
                                            data-bs-toggle="tooltip" data-bs-placement="right" data-bs-title="⌘ + s">
                                        save
                                    </button>
                                </div>
                            </div>
                            <div class="list-group list-group-flush json-history-list"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <h5>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                                     class="bi bi-file-text" viewBox="0 0 16 16">
                                    <path d="M5 4a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm-.5 2.5A.5.5 0 0 1 5 6h6a.5.5 0 0 1 0 1H5a.5.5 0 0 1-.5-.5zM5 8a.5.5 0 0 0 0 1h6a.5.5 0 0 0 0-1H5zm0 2a.5.5 0 0 0 0 1h3a.5.5 0 0 0 0-1H5z"/>
                                    <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
                                </svg>
                                Preview
                            </h5>
                            <div class="json-history-editor" id="jsonHistoryPreview"></div>
                        </div>
                    </div>
                </div>
                <br/>
            </div>

            <div class="row editor-container">
                <div class="editor-view">
                    <div class="editor">
                        <div id="inputEditor" class="vertical-area"></div>
                    </div>
                    <div class="resizer" id="editorResizer">︙</div>
                    <div class="editor refresh-effect-area">
                        <div id="resultEditor" class="vertical-area"></div>
                    </div>
                </div>
            </div>
            <div id="ads"></div>
        </div>
    </div>
</main>
<div class="position-absolute bottom-0 ts-history-layer">
    <div class="ts-history-fold" data-bs-toggle="collapse" data-bs-target="#navbarToggleExternalContent"
         aria-controls="navbarToggleExternalContent" aria-expanded="false">
        <span class="ts-history-fold-title">Epoch timestamp converter</span>
        <span class="float-end ts-history-fold-close" role="button"></span>
    </div>
    <div class="collapse show ts-history-wrapper" id="navbarToggleExternalContent-disable">
        <div class="ts-history">
            <div class="ts-history-row" data-date="Added time">
                <div>Input</div>
                <div>UTC</div>
                <div id="currentTimeZone"></div>
                <div class="ts-col-1" style="display: none">Relative</div>
                <div class="ts-col-2" style="display: none">Epoch(s)</div>
                <div class="ts-col-3" style="display: none">Epoch(ms)</div>
            </div>
        </div>
    </div>
</div>
<div class="position-absolute bottom-0 end-0 border-0 log-toast">
    <div class="toast align-items-center" role="alert" aria-live="polite" aria-atomic="true" id="toastBody">
        <div class="d-flex">
            <div class="toast-body" id="toastContent"></div>
            <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>
<!--<div class="position-absolute jsonata-example" style="display: none;">-->
<!--    <div class="jsonata-example-img">-->
<!--        <img src="" alt="jsonata example image"/>-->
<!--    </div>-->
<!--</div>-->

<script src="https://fastly.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
        crossorigin="anonymous"></script>
<script src="https://fastly.jsdelivr.net/npm/ace-builds@1.33.1/src-min-noconflict/ace.min.js"></script>
<script src="https://fastly.jsdelivr.net/npm/lossless-json@4.0.1/lib/umd/lossless-json.min.js"></script>
<script src="dragmove.js"></script>
<script src="json-sort.js"></script>
<script src="https://fastly.jsdelivr.net/npm/jsonata/jsonata.min.js"></script>
<script src="common.js"></script>

<script>
    const deepSort = sort

    // editor
    let inputEditor = undefined
    let resultEditor = undefined
    let previewEditor = undefined

    // initialize editors
    const initEditorInstances = () => {
        inputEditor = ace.edit("inputEditor");
        inputEditor.setTheme("ace/theme/dawn");
        inputEditor.session.setMode("ace/mode/json");

        resultEditor = ace.edit("resultEditor");
        const theme = getSetting(SETTINGS.latestResultEditorTheme)
        resultEditor.setTheme(!!theme ? theme : "ace/theme/dawn");
        resultEditor.session.setMode("ace/mode/json5");
        resultEditor.session.setUseWorker(false)
        resultEditor.setShowPrintMargin(false)
        resultEditor.setReadOnly(true)

        previewEditor = ace.edit("jsonHistoryPreview");
        previewEditor.setTheme("ace/theme/dawn");
        previewEditor.session.setMode("ace/mode/json");
        previewEditor.session.setUseWorker(false)
        previewEditor.setShowPrintMargin(false)
        previewEditor.setReadOnly(true)
        previewEditor.renderer.$cursorLayer.element.style.display = "none"

        const latestJsonContent = getSetting(SETTINGS.latestJsonContent)
        if (!!latestJsonContent) {
            inputEditor.setValue("")
            inputEditor.insert(latestJsonContent) // call input event
        }
        console.log("init editor instances", [inputEditor, resultEditor])
    }

    const getCurrentEditorOptions = () => {
        const defaultOptions = {
            fontFamily: "JetBrains Mono",
            fontSize: 12,
            wrap: null,
            tabSize: 2,
            useSoftTabs: false,
            showInvisibles: false,
        }
        const savedEditorOptionsStr = getSetting(SETTINGS.editorOptions)

        let savedEditorOptions = {}
        if (!!savedEditorOptionsStr) {
            savedEditorOptions = JSON.parse(savedEditorOptionsStr)
        }
        const currentOptions = JSON.parse(JSON.stringify(defaultOptions))

        return Object.assign(currentOptions, savedEditorOptions)
    }

    const initEditorOptions = () => {
        if (!inputEditor || !resultEditor) {
            console.error("not yet init editor")
            return
        }

        const defaultOptions = getCurrentEditorOptions()
        updateEditorOptions(defaultOptions)

        // apply editor setting
        document.querySelector("#editorLineWrap").checked = defaultOptions.wrap
        document.querySelector("#sortJson").checked = getSetting(SETTINGS.sortJson)
        document.querySelector("#includeTimeStampToJsonResult").checked = getSetting(SETTINGS.includeTimeStampToJsonResult)
        document.querySelector("#displayConvertedTimeStamp").checked = getSetting(SETTINGS.displayConvertedTimeStamp)

        const editorWidth = getSetting(SETTINGS.latestInputEditorWidth)
        if (!!editorWidth) {
            refreshEditorWidthSize(Number(editorWidth.substring(0, editorWidth.indexOf("px"))))
            // document.querySelector(".editor-view > .editor:first-child").style.flexBasis = editorWidth
        }

        initializedEditors = true
    }

    const initTimeStampConverterOptions = () => {
        console.log("init timestamp converter settings", getSetting(SETTINGS.ignoreDuplicateLastRow))
        document.querySelector("#ignoreDuplicateLastRow").checked = getSetting(SETTINGS.ignoreDuplicateLastRow)
    }

    const updateEditorOptions = (options) => {
        if (!inputEditor || !resultEditor) {
            console.error("not yet init editor")
            return
        }

        // validate
        if (!!options.fontSize && (options.fontSize < 10 || options.fontSize > 100)) {
            console.warn("fontSize min: 10, max: 100")
            return
        }

        const currentOptions = getCurrentEditorOptions()
        const updateOptions = JSON.parse(JSON.stringify(currentOptions))
        if (!!options) {
            Object.assign(updateOptions, options)
        }

        inputEditor.setOptions(updateOptions)
        resultEditor.setOptions(updateOptions)
        previewEditor.setOptions(updateOptions)
        setSetting(SETTINGS.editorOptions, JSON.stringify(updateOptions))

        console.log("updated editor options", updateOptions)
    }

    // setting key names
    const SETTINGS = {
        sortJson: "sortJson",
        latestJsonContent: "latestJsonContent",
        editorOptions: "editorOptions",
        latestInputEditorWidth: "latestInputEditorWidth",
        ignoreDuplicateLastRow: "ignoreDuplicateLastRow",
        jsonHistory: "jsonHistory",
        latestResultEditorTheme: "latestResultEditorTheme",
        includeTimeStampToJsonResult: "includeTimeStampToJsonResult",
        displayConvertedTimeStamp: "displayConvertedTimeStamp",
    }
    // etc options
    const getSetting = (key) => {
        if (key === SETTINGS.sortJson) {
            const sortJson = localStorage.getItem(SETTINGS.sortJson)
            return toBoolean(sortJson, false)
        }

        if (key === SETTINGS.latestJsonContent) {
            return localStorage.getItem(SETTINGS.latestJsonContent)
        }

        if (key === SETTINGS.editorOptions) {
            return localStorage.getItem(SETTINGS.editorOptions)
        }

        if (key === SETTINGS.latestInputEditorWidth) {
            return localStorage.getItem(SETTINGS.latestInputEditorWidth)
        }

        if (key === SETTINGS.latestResultEditorTheme) {
            return localStorage.getItem(SETTINGS.latestResultEditorTheme)
        }

        if (key === SETTINGS.ignoreDuplicateLastRow) {
            return toBoolean(localStorage.getItem(SETTINGS.ignoreDuplicateLastRow), false)
        }

        if (key === SETTINGS.includeTimeStampToJsonResult) {
            return toBoolean(localStorage.getItem(SETTINGS.includeTimeStampToJsonResult), false)
        }

        if (key === SETTINGS.displayConvertedTimeStamp) {
            return toBoolean(localStorage.getItem(SETTINGS.displayConvertedTimeStamp), true)
        }

        if (key === SETTINGS.jsonHistory) {
            const listStr = localStorage.getItem(SETTINGS.jsonHistory)
            if (!!listStr) {
                return JSON.parse(listStr)
            } else {
                return []
            }
        }

        throw Error(`not supported option: ${key}`)
    }

    const setSetting = (key, value) => {
        if (key === SETTINGS.jsonHistory) {
            localStorage.setItem(key, JSON.stringify(value))
        } else {
            localStorage.setItem(key, value)
        }
    }

    const removeSetting = (key) => {
        localStorage.removeItem(key)
    }

    // resizing editor width size
    const RESIZING_DIV_WIDTH = 15 // px
    const refreshEditorWidthSize = (width) => {
        const $el = document.querySelector(".editor-view")
        const style = $el.currentStyle || window.getComputedStyle($el)

        const maxWidth = $el.clientWidth - RESIZING_DIV_WIDTH - parseInt(style.paddingLeft) - parseInt(style.paddingRight)

        if (width < 0 || width >= maxWidth) {
            console.warn(`can not less then 0 or grete then ${maxWidth}`)
        }

        const $editor = document.querySelector(".editor-view > .editor:first-child")

        if (width === null) {
            $editor.style.removeProperty("flex-basis")
            return null
        } else if (width <= 0) {
            const minWidth = 0.5
            $editor.style.flexBasis = `${minWidth}px`
            return minWidth
        } else if (width > maxWidth) {
            $editor.style.flexBasis = `${maxWidth}px`
            return maxWidth
        } else {
            $editor.style.flexBasis = `${width}px`
            return width
        }
    }

    // ======================================================================================================
    // json bookmark
    // ======================================================================================================
    // TODO: use indexedDB instead of local storage

    const refreshJsonHistory = () => {
        const history = getSetting(SETTINGS.jsonHistory)
        if (history.length === 0) {
            document.querySelector("#jsonHistoryCount").style.display = 'none'
        } else {
            document.querySelector("#jsonHistoryCount").innerHTML = history.length
            document.querySelector("#jsonHistoryCount").style.display = 'unset'
        }

        const historyTemplate = (id, title, addedAt, active) => `
            <div class="list-group-item list-group-item-action json-history-list-row ${active ? 'active' : ''}" data-id="${id}" onclick="clickJsonHistory('${id}')">
                <div class="json-history-row-title float-start">
                    ${title}
                </div>
                <div class="json-history-row-buttons float-end">
                    ${!!addedAt ? `<small>${formatTimeAgo(new Date(addedAt))}</small>&nbsp;` : ''}
                    <button type="button" class="btn btn-warning" onclick="editJsonHistory('${id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pencil" viewBox="0 0 16 16">
                            <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/>
                        </svg>
                    </button>
                    <button type="button" class="btn btn-danger" onclick="deleteJsonHistory('${id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                             fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                            <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5Zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6Z"/>
                            <path d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1ZM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118ZM2.5 3h11V2h-11v1Z"/>
                        </svg>
                    </button>
                </div>
            </div>
        `.trim()
        const currentPreviewId = document.querySelector(".json-history-editor").dataset.id
        const $rows = history.map((row) => {
            return historyTemplate(
                row.key,
                !!row.name ? row.name : new Date(row.addedAt).toLocaleString(),
                row.addedAt,
                (currentPreviewId === String(row.key)),
            )
        }).join("")
        if ($rows === "") {
            document.querySelector(".json-history-list").innerHTML = `
                <div class="list-group-item list-group-item-action disabled">
                    No data saved.
                </div>
            `
        } else {
            document.querySelector(".json-history-list").innerHTML = $rows
        }
    }

    const clickJsonHistory = (id) => {
        const result = [...getSetting(SETTINGS.jsonHistory)].find((data) => String(data.key) === id)
        if (!!result) {
            previewEditor.setValue("")
            previewEditor.insert(result.value)
            document.querySelector(".json-history-editor").dataset.id = id
            document.querySelectorAll(".json-history-list-row").forEach(el => {
                if (el.dataset.id === String(id)) {
                    el.classList.add("active")
                } else {
                    el.classList.remove("active")
                }
            })
        }
    }

    const deleteJsonHistory = (id) => {
        const history = getSetting(SETTINGS.jsonHistory)
        const result = [...history].find((data) => String(data.key) === id)
        if (!!result) {
            previewEditor.setValue("")
            previewEditor.insert("")
            document.querySelector(".json-history-editor").dataset.id = undefined
        }
        setSetting(SETTINGS.jsonHistory, history.filter(item => String(item.key) !== id))
        refreshJsonHistory()
    }

    const editJsonHistory = (id) => {
        const data = [...getSetting(SETTINGS.jsonHistory)].filter((el) => String(el.key) === id)[0]

        const name = prompt("namespace", !!data.name ? data.name : undefined).trim()
        if (!name) {
            return
        }

        const history = [...getSetting(SETTINGS.jsonHistory)].map(item => {
            if (String(item.key) === id) {
                item['name'] = name
            }
            return item
        })
        setSetting(SETTINGS.jsonHistory, history)
        refreshJsonHistory()
    }

    const saveJson = (jsonStr) => {
        const before = getSetting(SETTINGS.jsonHistory)
        if (before.length > 0) {
            const lastData = before[0].value
            if (lastData === jsonStr) {
                showAlert("It's the same as the last saved JSON data, so that JSON is skipped.")
                return
            }
        }
        const newData = {
            key: String(Date.now()),
            value: jsonStr,
            addedAt: Date.now(),
        }
        setSetting(SETTINGS.jsonHistory, [newData, ...before])
    }

    // ======================================================================================================
    // json formatter
    // ======================================================================================================
    const format = async (content, expression, options = {
        force: false,
        sort: false,
    }) => {
        console.debug("--------------------------------------------------------")
        console.debug("input", content)
        console.debug("expression", expression)
        console.debug("options", options)
        console.debug("temp", temp)
        console.debug("........................................................")

        if (!options.force && temp === content) return
        if (content.trim() === '') return ''

        // 1. json formatting
        let result
        try {
            let jsonResult = LosslessJSON.parse(content)
            console.debug("input(json)", jsonResult)
            if (options.sort) {
                console.debug("sort!")
                jsonResult = deepSort(jsonResult)
            }

            result = LosslessJSON.stringify(jsonResult, undefined, 2)
        } catch (e) {
            throw e
        }
        console.debug("result(format)", result)
        // result = Promise.resolve(result)

        // 2. json filtering
        let filtered
        if (!!expression && expression.trim().length > 0) {
            // https://docs.jsonata.org/string-functions
            const jsonataExp = jsonata(expression)
            const jsonataResult = await jsonataExp.evaluate(JSON.parse(result))

            filtered = JSON.stringify(jsonataResult, undefined, 2)
            console.debug("result(filter)", filtered)

            // [references]
            // https://try.jsonata.org/
            // https://maxleiko.github.io/json-query-tester/
            // https://mwh.github.io/jqjs/demo.html
        }

        // temp = content

        // TODO: return null when no change
        if (!!expression) {
            return filtered
        }

        return result
    }
    const showAlert = (message) => {
        document.querySelector("#toastContent").innerHTML = message
        const toastBody = bootstrap.Toast.getOrCreateInstance(document.getElementById('toastBody'))
        toastBody.show()
    }

    let refreshTimer
    const effectRefersh = () => {
        // update effect
        clearTimeout(refreshTimer)
        const area = document.querySelector(".refresh-effect-area")
        area.style.outline = "solid rgb(85, 255, 0) 2px"
        refreshTimer = setTimeout(() => {
            area.style.outline = "unset"
        }, 220)
    }

    let temp = ""
    const runFormat = (options) => {
        const force = options == null ? false : (!!options.force ? options.force : false)
        const jsonStr = inputEditor.getValue()
        format(
            jsonStr,
            document.querySelector("#jsonQuery").value,
            {
                sort: getSetting(SETTINGS.sortJson),
                force: force,
            }
        ).then((result) => {
            // set result
            // console.log(result)
            const currentTimezoneOffset = new Date().getTimezoneOffset()
            if (!!result || result === "") {
                let resultJson = result

                // Adds a timestamp converted to a local date time.
                if (getSetting(SETTINGS.displayConvertedTimeStamp)) {
                    resultJson = resultJson
                        .split("\n")
                        .map((line) => {
                            let result = line
                            let annotation = []

                            if (line === '{' && line === '}') {
                                return result
                            }

                            const lineObj = parseLine(line)
                            switch (lineObj.type) {
                                case ParseType.JSON_KEY_AND_NUMBER_STRING_VALUE:
                                    const lowercaseKey = lineObj.key.toLowerCase()
                                    if (
                                        (
                                            lineObj.key.endsWith("Minutes")
                                            || lineObj.key.endsWith("At")
                                            || lineObj.key.endsWith("From")
                                            || lineObj.key.endsWith("To")
                                            || lowercaseKey.includes("timestamp")
                                        )
                                        && (lineObj.value >= 60 || lineObj.value <= -60)
                                    ) {
                                        let epochTime = undefined
                                        if (lineObj.value > 0) {
                                            try {
                                                const temp = convertTimeStampToDate(lineObj.value)
                                                if (temp.getFullYear() !== 1970 && temp.getMonth() !== 1) {
                                                    epochTime = temp
                                                }
                                            } catch (e) {
                                                console.error(`fail parse value: ${lineObj.value}`, e)
                                            }
                                        }
                                        if (epochTime instanceof Date && !isNaN(epochTime)) {
                                            annotation.push(`${toIsoString(epochTime)}`)
                                        }
                                    }

                                    break
                                case ParseType.JSON_KEY_AND_NUMBER_VALUE: {
                                    let epochTime = undefined
                                    if (lineObj.value > 0) {
                                        try {
                                            const temp = convertTimeStampToDate(lineObj.value)
                                            if (temp.getFullYear() !== 1970 && temp.getMonth() !== 1) {
                                                epochTime = temp
                                            }
                                        } catch (e) {
                                            console.error(`fail parse value: ${lineObj.value}`, e)
                                        }
                                    }
                                    if (epochTime instanceof Date && !isNaN(epochTime)) {
                                        annotation.push(`${toIsoString(epochTime)}`)
                                    }

                                    if (
                                        !epochTime
                                        && annotation.length === 0
                                        && lineObj.key.includes("Minutes")
                                        && (lineObj.value >= 60 || lineObj.value <= -60)
                                    ) {
                                        const hoursObj = convertMinutesToHours(lineObj.value)
                                        if (hoursObj.divisible) {
                                            annotation.push(`${hoursObj.convertedHours}h`)
                                        } else {
                                            annotation.push(`${hoursObj.convertedHours}h (${hoursObj.detail.hours}h ${hoursObj.detail.minutes}m)`)
                                        }
                                    }
                                    break
                                }
                                case ParseType.NUMBER_VALUE: {
                                    let epochTime = undefined
                                    if (lineObj.value > 0) {
                                        try {
                                            const temp = convertTimeStampToDate(lineObj.value)
                                            if (temp.getFullYear() !== 1970 && temp.getMonth() !== 1) {
                                                epochTime = temp
                                            }
                                        } catch (e) {
                                            console.error(`fail parse value: ${lineObj.value}`, e)
                                        }
                                    }
                                    if (epochTime instanceof Date && !isNaN(epochTime)) {
                                        annotation.push(`${toIsoString(epochTime)}`)
                                    }
                                    break
                                }
                                case ParseType.JSON_KEY_AND_DATE_STRING_VALUE:
                                case ParseType.DATE_STRING_VALUE: {
                                    if (stripQuotes(lineObj.originValue).endsWith("Z")) {
                                        annotation.push(toIsoString(lineObj.value))
                                    }
                                    break
                                }
                                case ParseType.JSON_KEY_AND_STRING_VALUE:
                                case ParseType.JSON_KEY_AND_UNKNOWN_VALUE:
                                case ParseType.STRING_VALUE:
                                case ParseType.NUMBER_STRING_VALUE:
                                case ParseType.UNKNOWN_VALUE:
                            }

                            if (annotation.length > 0) {
                                result += ` // ${annotation.join(", ")}`
                            }
                            return result
                        })
                        .join("\n")
                }

                // Add formatting time to first line
                if (getSetting(SETTINGS.includeTimeStampToJsonResult)) {
                    const now = new Date()
                    resultJson = `// ${now.toLocaleString()}\n${resultJson}`
                }

                resultEditor.setValue("")
                resultEditor.insert(resultJson)

                // update effect
                effectRefersh()
            }
        }).catch((e) => {
            showAlert(`⚠️ ${(truncate(
                e.message,
                500,
                `<br/><i style="color: grey;">${escape("If you want a detailed reason, open the console.")}</i>`
            ))}`)
            console.error(e)
            return undefined
        }).finally(() => {
            setSetting(SETTINGS.latestJsonContent, jsonStr)
            temp = jsonStr
        })

        updateJsonSize()
    }

    const ParseType = {
        JSON_KEY_AND_NUMBER_VALUE: "JSON_KEY_AND_NUMBER_VALUE",
        JSON_KEY_AND_NUMBER_STRING_VALUE: "JSON_KEY_AND_NUMBER_STRING_VALUE",
        JSON_KEY_AND_DATE_STRING_VALUE: "JSON_KEY_AND_DATE_STRING_VALUE",
        JSON_KEY_AND_STRING_VALUE: "JSON_KEY_AND_STRING_VALUE",
        JSON_KEY_AND_UNKNOWN_VALUE: "JSON_KEY_AND_UNKNOWN_VALUE",
        NUMBER_VALUE: "NUMBER_VALUE",
        NUMBER_STRING_VALUE: "NUMBER_STRING_VALUE",
        STRING_VALUE: "STRING_VALUE",
        DATE_STRING_VALUE: "DATE_STRING_VALUE",
        UNKNOWN_VALUE: "UNKNOWN_VALUE",
    }

    const parseLine = (line) => {
        if (/["'](.+)["']: (.+)[,|]?$/.test(line)) {
            const jsonKey = stripQuotes(line.substring(0, line.indexOf(': ')).trim())
            const jsonValue = stripComma(line.substring(line.indexOf(': ') + 1).trim())

            // parse json value
            if (isNumeric(jsonValue)) {
                try {
                    return {
                        "type": ParseType.JSON_KEY_AND_NUMBER_VALUE,
                        "key": jsonKey,
                        "value": parseInt(jsonValue),
                    }
                } catch (e) {
                    return {
                        "type": ParseType.JSON_KEY_AND_UNKNOWN_VALUE,
                        "key": jsonKey,
                        "value": jsonValue,
                    }
                }
            }

            const startChar = jsonValue.charAt(0)
            const lastChar = jsonValue.charAt(jsonValue.length - 1)
            if ((startChar === '"' || startChar === "'") && (lastChar === '"' || lastChar === "'")) {
                const temp = stripQuotes(jsonValue)
                if (isNumeric(temp)) {
                    try {
                        return {
                            "type": ParseType.JSON_KEY_AND_NUMBER_STRING_VALUE,
                            "key": jsonKey,
                            "value": parseInt(temp),
                            "originValue": jsonValue
                        }
                    } catch (e) {
                        return {
                            "type": ParseType.JSON_KEY_AND_UNKNOWN_VALUE,
                            "key": jsonKey,
                            "value": jsonValue,
                        }
                    }
                } else {
                    try {
                        const temp = new Date(stripQuotes(jsonValue))
                        if (!!temp && temp instanceof Date && !isNaN(temp)) {
                            return {
                                "type": ParseType.JSON_KEY_AND_DATE_STRING_VALUE,
                                "key": jsonKey,
                                "value": temp,
                                "originValue": jsonValue
                            }
                        }
                    } catch (e) {
                        console.error(`fail parse value: ${jsonValue}`, e)
                    }

                    return {
                        "type": ParseType.JSON_KEY_AND_STRING_VALUE,
                        "key": jsonKey,
                        "value": temp,
                        "originValue": jsonValue
                    }
                }
            }

            // default
            return {
                "type": ParseType.JSON_KEY_AND_UNKNOWN_VALUE,
                "key": jsonKey,
                "value": jsonValue,
            }
        }

        // parse single line like element in array
        const textValue = stripComma(line.trim())

        if (isNumeric(textValue)) {
            return {
                "type": ParseType.NUMBER_VALUE,
                "value": parseInt(textValue),
            }
        } else {
            const tempTextValue = stripQuotes(textValue)

            if (isNumeric(tempTextValue)) {
                return {
                    "type": ParseType.NUMBER_STRING_VALUE,
                    "value": parseInt(tempTextValue),
                    "originValue": textValue,
                }
            } else {
                try {
                    const temp = new Date(tempTextValue)
                    if (!!temp && temp instanceof Date && !isNaN(temp)) {
                        return {
                            "type": ParseType.DATE_STRING_VALUE,
                            "value": temp,
                            "originValue": tempTextValue
                        }
                    }
                } catch (e) {
                    console.error(`fail parse value: ${tempTextValue}`, e)
                }
            }

            // default
            return {
                "type": ParseType.UNKNOWN_VALUE,
                "value": textValue,
            }
        }
    }

    const updateJsonSize = () => {
        const content = inputEditor.getValue()
        const size = new Blob([content]).size
        document.querySelector("#jsonSizeValue").innerHTML = `<b>${content.length.toLocaleString()}</b> characters, <b>${size.toLocaleString()}</b> bytes`
    }

    // ======================================================================================================
    // timestamp parser
    // ======================================================================================================

    let rows = []
    const appendRow = (input, date) => {
        const now = new Date()
        const time = now.toTimeString().split(' ')[0]
        const rowId = now.getTime()

        // TODO: https://dkje.github.io/2020/08/18/createDomElement/#3-document-fragment
        let row
        try {
            const showColumn1 = document.querySelector("#showRelativeTimeColumn").checked ? "table-cell" : "none"
            const showColumn2 = document.querySelector("#showEpochSecondColumn").checked ? "table-cell" : "none"
            const showColumn3 = document.querySelector("#showEpochMilliSecondColumn").checked ? "table-cell" : "none"

            row = `<div class="ts-history-row" data-date="${time}" data-id="${rowId}" onclick="removeTimeStampRow(${rowId})">
                    <div>${input}</div>
                    <div>${date.toISOString()}</div>
                    <div>${date.toLocaleString()}</div>
                    <div class="ts-col-1" style="display: ${showColumn1}">${formatTimeAgo(date)}</div>
                    <div class="ts-col-2" style="display: ${showColumn2}">${date.getTime() / 1000}</div>
                    <div class="ts-col-3" style="display: ${showColumn3}">${date.getTime()}</div>
                </div>`.trim()
        } catch (e) {
            console.warn(`input: [${input}], date: [${date}] throw: ${e}`)
            return
        }

        // TODO: check settings #ignoreDuplicateLastRow
        const ignoreDuplicateLastRow = getSetting(SETTINGS.ignoreDuplicateLastRow)
        const lastRow = rows[rows.length - 1]
        if (ignoreDuplicateLastRow && input === lastRow) {
            console.log("duplicate last value")
            return
        }
        rows.push(input)

        // set scroll to bottom
        document.querySelector(".ts-history").innerHTML += row
        const element = document.querySelector(".ts-history-wrapper")
        element.scroll({top: element.scrollHeight, behavior: 'smooth'});
    }

    const removeTimeStampRow = (rowId) => {
        [...document.querySelectorAll(".ts-history-row")]
            .filter((el) => !!el.dataset.id && Number(el.dataset.id) === rowId)
            .forEach((el) => {
                document.querySelector(".ts-history").removeChild(el)
            })
    }

    const appendTimeStamp = (editor, func) => {
        setTimeout(() => {
            console.log("append timestamp")
            const value = toNumber(editor.getSelectedText().trim())
            if (!value) return

            // convert epoch millisecond or second to date
            const date = convertTimeStampToDate(value)

            appendRow(value, date)
            if (!!func) {
                func()
            }
        }, 10);
    }

    const convertTimeStampToDate = (timeStamp) => {
        // convert epoch millisecond or second to date
        let date = new Date(timeStamp)
        if (Math.abs(Date.now() - date) < Math.abs(Date.now() - date * 1000)) {
            // epoch millisecond
            date = new Date(timeStamp)
        } else {
            // epoch second
            date = new Date(timeStamp * 1000)
        }

        return date
    }

    const toIsoString = (date) => {
        const tzo = -date.getTimezoneOffset(),
            dif = tzo >= 0 ? '+' : '-',
            pad = function (num) {
                return (num < 10 ? '0' : '') + num;
            };

        return date.getFullYear() +
            '-' + pad(date.getMonth() + 1) +
            '-' + pad(date.getDate()) +
            'T' + pad(date.getHours()) +
            ':' + pad(date.getMinutes()) +
            ':' + pad(date.getSeconds()) +
            dif + pad(Math.floor(Math.abs(tzo) / 60)) +
            ':' + pad(Math.abs(tzo) % 60);
    }

    const appendJsonHistory = () => {
        const jsonStr = inputEditor.getValue()
        if (!!jsonStr && jsonStr.length > 0) {
            saveJson(inputEditor.getValue())
            refreshJsonHistory()
        } else {
            showAlert("empty data")
        }
    }

    // ======================================================================================================
    // event listeners
    // ======================================================================================================
    let initializedEditors = false
    document.addEventListener('DOMContentLoaded', () => {
        // TODO: fix header in datetime table to top
        // TODO: support big number when filtering json (jsonata)
        // FIXME: disable timestamp converter when find numbers using ace editor
        // TODO: fix z-index of bookmark preview in mobile

        initEditorInstances()
        initEditorOptions()
        initTimeStampConverterOptions()
        refreshJsonHistory()

        // https://github.com/daybrush/moveable
        // https://github.com/knadh/dragmove.js
        dragmove(document.querySelector(".ts-history-layer"), document.querySelector(".ts-history-fold"));

        // enable tooltips
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        // set current timezone
        const currentTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone
        document.querySelector("#currentTimeZone").innerHTML = `${currentTimeZone} (<i>current</i>)`

        // add default value in editor
        inputEditor.on("input", () => {
            runFormat()
        })

        // add events for timestamp converter
        let eventLock = false
        inputEditor.on("dblclick", () => {
            console.log("double click in input editor")
            eventLock = true
            appendTimeStamp(inputEditor)
        });
        resultEditor.on("dblclick", () => {
            console.log("double click in result editor")
            eventLock = true
            appendTimeStamp(resultEditor)
        });
        // ref: https://github.com/ajaxorg/ace/blob/c910951d1ff7f5ab32ab424ec61604f61696780d/src/virtual_renderer.js#L1678C31-L1678C42
        resultEditor.renderer.on('themeChange', (e) => {
            if (!initializedEditors) {
                console.log("not yet initialize editors", e)
                return
            }
            console.log("change editor settings", e)
            setSetting(SETTINGS.latestResultEditorTheme, e.theme)
        })
        inputEditor.session.selection.on("changeSelection", debounce((e) => {
            if (eventLock) {
                // prevent duplicate events after dbclick event call
                eventLock = false
                return
            }
            console.log("change selection in input editor")
            const selection = inputEditor.getSelectedText()
            if (!selection) return

            const timestamp = toNumber(selection)
            if (!!timestamp) {
                console.log("is timestamp value")
                appendTimeStamp(inputEditor)
                return
            }

            const str = selection
                .replaceAll('"', '')
                .trim()

            if (isIsoDate(str)) {
                console.log("is iso date format")
                appendRow(str, new Date(Date.parse(str)))
                return
            }
        }, 500))
        resultEditor.session.selection.on("changeSelection", debounce((e) => {
            if (eventLock) {
                // prevent duplicate events after dbclick event call
                eventLock = false
                return
            }
            console.log("change selection in result editor")
            const selection = resultEditor.getSelectedText()
            if (!selection) return

            const timestamp = toNumber(selection)
            if (!!timestamp) {
                appendTimeStamp(resultEditor)
                return
            }

            const str = selection.replaceAll('"', '')
            if (isIsoDate(str)) {
                console.log("iso date format")
                appendRow(str, new Date(Date.parse(str)))
                return
            }
        }, 500))

        // add dom events
        const $sortJson = document.querySelector("#sortJson")
        const $resizer = document.querySelector("#editorResizer")
        const $editor = document.querySelector(".editor-view > .editor:first-child")
        const $fontSizeUp = document.querySelector("#sizeUpJsonFont")
        const $fontSizeDown = document.querySelector("#sizeDownJsonFont")
        const $fontSizeReset = document.querySelector("#resetJsonFont")
        const $editorLineWrap = document.querySelector("#editorLineWrap")

        const $converterColumn1 = document.querySelector("#showRelativeTimeColumn")
        const $converterColumn2 = document.querySelector("#showEpochSecondColumn")
        const $converterColumn3 = document.querySelector("#showEpochMilliSecondColumn")

        const $copy = document.querySelector("#copy")
        $copy.addEventListener("click", (e) => {
            const content = resultEditor.getValue()
            if (content.trim() === "") return

            navigator.clipboard.writeText(content).then(() => {
                const beforeLabel = $copy.textContent
                const beforeClass = [...$copy.classList].find((cls) => {
                    return !!cls.match(/btn-\w+/)
                })
                $copy.classList.remove(beforeClass)
                $copy.classList.add("btn-success")
                $copy.textContent = "copied!"
                setTimeout(() => {
                    $copy.classList.remove("btn-success")
                    $copy.classList.add(beforeClass)
                    $copy.textContent = beforeLabel
                }, 500)
            })
        })

        document.querySelector("#minify").addEventListener("click", (e) => {
            const content = inputEditor.getValue()
            if (content.trim() === "") return

            const minified = LosslessJSON.stringify(LosslessJSON.parse(content))
            inputEditor.setValue("")
            inputEditor.insert(minified)
        })

        document.querySelector("#escape").addEventListener("click", (e) => {
            const content = inputEditor.getValue()
            if (content.trim() === "") return

            const escaped = LosslessJSON.stringify(LosslessJSON.parse(content))
            inputEditor.setValue("")
            inputEditor.insert(LosslessJSON.stringify(escaped))
        })

        document.querySelector("#unescape").addEventListener("click", (e) => {
            const content = inputEditor.getValue()
            if (content.trim() === "") return

            const unescaped = LosslessJSON.parse(content)

            if (unescaped instanceof Object) return

            inputEditor.setValue("")
            inputEditor.insert(unescaped)
        })

        $sortJson.addEventListener("change", (e) => {
            setSetting("sortJson", e.target.checked)

            runFormat({force: true})
        })

        document.querySelector("#jsonQuery").addEventListener("input", (e) => {
            runFormat({force: true})
        })
        document.querySelector("#jsonQuery").addEventListener("keydown", (e) => {
            if (e.key === 'Tab') {
                e.preventDefault();
                const {target} = e
                const start = target.selectionStart;
                const end = target.selectionEnd;

                // set textarea value to: text before caret + tab + text after caret
                target.value = target.value.substring(0, start) +
                    "\t" + target.value.substring(end);

                // put caret at right position again
                target.selectionStart = target.selectionEnd = start + 1;
            }
        })

        const resize = (e) => {
            let clientX = e.clientX
            if (!clientX) {
                // support touch event
                if (!e.touches || e.touches.length === 0) {
                    console.warn("not found event.touches")
                    return
                }
                clientX = e.touches[0].clientX
            }
            const width = (clientX - (RESIZING_DIV_WIDTH + (RESIZING_DIV_WIDTH / 2)))

            const appliedWidth = refreshEditorWidthSize(width)
            setSetting(SETTINGS.latestInputEditorWidth, `${appliedWidth}px`)
        }
        $resizer.addEventListener("mousedown", (e) => {
            if (e.offsetX < RESIZING_DIV_WIDTH) {
                document.addEventListener("mousemove", resize, false)
            }
        }, false);
        document.addEventListener("mouseup", (e) => {
            document.removeEventListener("mousemove", resize, false)
        }, false);
        $resizer.addEventListener("dblclick", (e) => {
            const widthStr = getSetting(SETTINGS.latestInputEditorWidth)
            console.log(widthStr)

            if (!!widthStr) {
                const width = widthStr.substring(0, widthStr.indexOf("px"))
                refreshEditorWidthSize(null)
                removeSetting(SETTINGS.latestInputEditorWidth)
                console.log("reset editor width")
            } else {
                const appliedWidth = refreshEditorWidthSize(0)
                setSetting(SETTINGS.latestInputEditorWidth, `${appliedWidth}px`)
                console.log("expend editor width")
            }
        });
        $resizer.addEventListener("touchstart", (e) => {
            document.addEventListener("touchmove", resize, false)
        }, false);
        document.addEventListener("touchend", (e) => {
            document.removeEventListener("touchmove", resize, false)
        }, false);

        // font size events
        $fontSizeUp.addEventListener("click", (e) => {
            const size = parseInt(inputEditor.getFontSize()) + 1
            updateEditorOptions({fontSize: size})
        })
        $fontSizeDown.addEventListener("click", (e) => {
            const size = parseInt(inputEditor.getFontSize()) - 1
            updateEditorOptions({fontSize: size})
        })
        $fontSizeReset.addEventListener("click", (e) => {
            updateEditorOptions({fontSize: null})
        })

        // etc options
        $editorLineWrap.addEventListener("change", (e) => {
            let enable = null
            if (e.target.checked) enable = true
            updateEditorOptions({wrap: enable})
        })

        document.querySelector("#includeTimeStampToJsonResult").addEventListener("change", (e) => {
            setSetting(SETTINGS.includeTimeStampToJsonResult, e.target.checked)
            runFormat({force: true})
        })

        document.querySelector("#displayConvertedTimeStamp").addEventListener("change", (e) => {
            setSetting(SETTINGS.displayConvertedTimeStamp, e.target.checked)
            runFormat({force: true})
        })

        $converterColumn1.addEventListener("change", (e) => {
            const display = e.target.checked ? "table-cell" : "none"
            document.querySelectorAll(".ts-col-1").forEach(e => e.style.display = display)
        })

        $converterColumn2.addEventListener("change", (e) => {
            const display = e.target.checked ? "table-cell" : "none"
            document.querySelectorAll(".ts-col-2").forEach(e => e.style.display = display)
        })

        $converterColumn3.addEventListener("change", (e) => {
            const display = e.target.checked ? "table-cell" : "none"
            document.querySelectorAll(".ts-col-3").forEach(e => e.style.display = display)
        })

        document.querySelector("#showTimestampConvertLayer").addEventListener("change", (e) => {
            document.querySelector(".ts-history-layer").style.display = e.target.checked ? "block" : "none"
        })

        document.querySelector("#ignoreDuplicateLastRow").addEventListener("change", (e) => {
            setSetting(SETTINGS.ignoreDuplicateLastRow, e.target.checked)
        })

        document.querySelector(".ts-history-fold-close").addEventListener("click", (e) => {
            document.querySelector("#showTimestampConvertLayer").click()
        })

        // document.querySelectorAll(".jsonata-example-trigger").forEach((el) => {
        //     el.addEventListener("click", (e) => {
        //         const filename = e.target.closest(".jsonata-example-trigger").dataset.fileName
        //
        //         document.querySelector(".jsonata-example-img > img").src = `assets/${filename}`
        //         document.querySelector(".jsonata-example").style.display = "unset";
        //     })
        // })
        // document.querySelector(".jsonata-example").addEventListener("click", (e) => {
        //     document.querySelector(".jsonata-example").style.display = "none";
        // })

        document.querySelectorAll(".new-feature").forEach((el) => {
            el.closest("button").addEventListener("click", (_) => {
                console.log("remove red-dot for new feature")
                el.style.display = "none"
            }, {once: true})
        })

        // shortcut
        if (isMac()) {
            document.querySelectorAll(".shortcut-window").forEach(el => {
                el.style.display = 'none'
            })
            document.querySelectorAll(".metakey").forEach(el => {
                el.innerHTML = "⌘"
            })
        } else {
            document.querySelectorAll(".shortcut-macos").forEach(el => {
                el.style.display = 'none'
            })
            document.querySelectorAll(".metakey").forEach(el => {
                el.innerHTML = "ctrl"
            })
        }

        // bookmark
        const bookmarkSaveTooltip = bootstrap.Tooltip.getInstance('#AddJsonHistory')
        if (isMac()) {
            bookmarkSaveTooltip.setContent({'.tooltip-inner': "⌘ + s"})
        } else {
            bookmarkSaveTooltip.setContent({'.tooltip-inner': "ctrl + s"})
        }
        document.querySelector("#AddJsonHistory").addEventListener("click", () => {
            appendJsonHistory()
        })
        document.addEventListener("keydown", function (e) { // shortcut
            // https://michilehr.de/overwrite-cmds-and-ctrls-in-javascript
            if ((isMac() ? e.metaKey : e.ctrlKey) && (e.key === 's' || e.keyCode === 83)) {
                e.preventDefault();
                appendJsonHistory()
            }
        }, false);
    }, false);

    function isMac() {
        return window.navigator.platform.match("Mac")
    }
</script>
</body>
</html>
